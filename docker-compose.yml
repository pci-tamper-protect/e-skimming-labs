version: '3.8'

services:
  # =============================================================================
  # TRAEFIK REVERSE PROXY - Single Entry Point
  # =============================================================================
  traefik:
    image: traefik:v3.0
    container_name: e-skimming-labs-traefik
    restart: unless-stopped
    ports:
      - '8080:80'      # Main HTTP entry point (all services accessible here)
      - '8443:443'     # HTTPS entry point (for production-like testing)
      - '8081:8080'    # Traefik dashboard (http://localhost:8081/dashboard/)
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker socket for service discovery
      - ./deploy/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./deploy/traefik/dynamic:/etc/traefik/dynamic:ro
    networks:
      - labs-network
    labels:
      - "traefik.enable=true"
      # Dashboard router
      - "traefik.http.routers.dashboard.rule=PathPrefix(`/dashboard`) || PathPrefix(`/api`)"
      - "traefik.http.routers.dashboard.service=api@internal"
      - "traefik.http.routers.dashboard.entrypoints=traefik"
    healthcheck:
      test: ['CMD', 'traefik', 'healthcheck', '--ping']
      interval: 10s
      timeout: 3s
      retries: 3

  # =============================================================================
  # LABS-HOME SERVICES (Landing Page & Shared Components)
  # =============================================================================

  # Home Index Service - Main landing page
  home-index:
    build:
      context: .
      dockerfile: deploy/shared-components/home-index-service/Dockerfile
    container_name: e-skimming-labs-home-index
    environment:
      - PORT=8080
      - ENVIRONMENT=local
      - DOMAIN=localhost:8080
      - LABS_DOMAIN=localhost:8080
      - LAB1_DOMAIN=localhost:8080/lab1
      - LAB2_DOMAIN=localhost:8080/lab2
      - LAB3_DOMAIN=localhost:8080/lab3
      # MAIN_DOMAIN is determined automatically based on ENVIRONMENT:
      # - local: uses DOMAIN (localhost:8080)
      # - stg: labs.stg.pcioasis.com
      # - prd: labs.pcioasis.com
      - LABS_PROJECT_ID=labs-prd
      # Auth configuration - set FIREBASE_API_KEY to enable auth
      # Use docker-compose.auth.yml override for full auth setup
      - ENABLE_AUTH=${ENABLE_AUTH:-false}
      - REQUIRE_AUTH=${REQUIRE_AUTH:-false}
      - FIREBASE_PROJECT_ID=${FIREBASE_PROJECT_ID:-}
      - FIREBASE_API_KEY=${FIREBASE_API_KEY:-}
    networks:
      - labs-network
    depends_on:
      - home-seo
      - labs-analytics
      - traefik
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      # Traefik configuration via labels (overrides dynamic config)
      - "traefik.enable=true"
      - "traefik.http.routers.home-index.rule=PathPrefix(`/`)"
      - "traefik.http.routers.home-index.priority=1"
      - "traefik.http.routers.home-index.entrypoints=web"
      - "traefik.http.services.home-index.loadbalancer.server.port=8080"

  # SEO Service - Cross-domain SEO integration
  home-seo:
    build:
      context: deploy/shared-components/seo-service
      dockerfile: Dockerfile
    container_name: e-skimming-labs-home-seo
    environment:
      - PORT=8080
      - PROJECT_ID=labs-home-prd
      - ENVIRONMENT=local
      - MAIN_DOMAIN=pcioasis.com
      - LABS_DOMAIN=localhost:8080
      - LABS_PROJECT_ID=labs-prd
    networks:
      - labs-network
    depends_on:
      - traefik
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.home-seo.rule=PathPrefix(`/api/seo`)"
      - "traefik.http.routers.home-seo.priority=500"
      - "traefik.http.routers.home-seo.entrypoints=web"
      - "traefik.http.routers.home-seo.middlewares=strip-seo-prefix@file"
      - "traefik.http.services.home-seo.loadbalancer.server.port=8080"

  # Analytics Service - Lab progress tracking
  labs-analytics:
    build:
      context: deploy/shared-components/analytics-service
      dockerfile: Dockerfile
    container_name: e-skimming-labs-analytics
    environment:
      - PORT=8080
      - PROJECT_ID=labs-prd
      - ENVIRONMENT=local
      - FIRESTORE_DATABASE=(default)
    networks:
      - labs-network
    depends_on:
      - traefik
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:8080/health']
      interval: 30s
      timeout: 10s
      retries: 3
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.labs-analytics.rule=PathPrefix(`/api/analytics`)"
      - "traefik.http.routers.labs-analytics.priority=500"
      - "traefik.http.routers.labs-analytics.entrypoints=web"
      - "traefik.http.routers.labs-analytics.middlewares=strip-analytics-prefix@file"
      - "traefik.http.services.labs-analytics.loadbalancer.server.port=8080"

  # =============================================================================
  # LAB 1: BASIC MAGECART ATTACK
  # =============================================================================

  # Lab 1 - Vulnerable E-commerce Site
  lab1-vulnerable-site:
    build: ./labs/01-basic-magecart/vulnerable-site
    container_name: lab1-techgear-store
    networks:
      - labs-network
    environment:
      - NGINX_HOST=localhost
      - NGINX_PORT=80
      - SKIMMER_VARIANT=base
    volumes:
      - ./labs/01-basic-magecart/vulnerable-site:/usr/share/nginx/html:ro
    depends_on:
      - traefik
    healthcheck:
      test: ['CMD', 'wget', '--no-verbose', '--tries=1', '--spider', 'http://localhost:80/']
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    labels:
      - "lab=lab1-basic-magecart"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab1.rule=PathPrefix(`/lab1`)"
      - "traefik.http.routers.lab1.priority=200"
      - "traefik.http.routers.lab1.entrypoints=web"
      - "traefik.http.routers.lab1.middlewares=lab1-auth-check@file,strip-lab1-prefix@file"
      - "traefik.http.services.lab1.loadbalancer.server.port=80"

  # Lab 1 - C2 Server (Data Collection)
  lab1-c2-server:
    build: ./labs/01-basic-magecart/malicious-code/c2-server
    container_name: lab1-attacker-c2
    networks:
      - labs-network
    volumes:
      - ./labs/01-basic-magecart/malicious-code/c2-server/stolen-data:/app/stolen-data
    environment:
      - NODE_ENV=development
      - PORT=3000
    depends_on:
      - traefik
    labels:
      - "lab=lab1-basic-magecart"
      - "component=c2-server"
      - "traefik.enable=true"
      - "traefik.http.routers.lab1-c2.rule=PathPrefix(`/lab1/c2`)"
      - "traefik.http.routers.lab1-c2.priority=300"
      - "traefik.http.routers.lab1-c2.entrypoints=web"
      - "traefik.http.routers.lab1-c2.middlewares=lab1-auth-check@file,strip-lab1-c2-prefix@file"
      - "traefik.http.services.lab1-c2-server.loadbalancer.server.port=3000"

  # =============================================================================
  # LAB 2: DOM-BASED SKIMMING
  # =============================================================================

  # Lab 2 - Vulnerable Banking Site
  lab2-vulnerable-site:
    build: ./labs/02-dom-skimming/vulnerable-site
    container_name: lab2-securebank
    networks:
      - labs-network
    depends_on:
      - traefik
    labels:
      - "lab=lab2-dom-skimming"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab2-main.rule=PathPrefix(`/lab2`)"
      - "traefik.http.routers.lab2-main.priority=200"
      - "traefik.http.routers.lab2-main.entrypoints=web"
      - "traefik.http.routers.lab2-main.middlewares=lab2-auth-check@file,strip-lab2-prefix@file"
      - "traefik.http.services.lab2-vulnerable-site.loadbalancer.server.port=80"

  # Lab 2 - C2 Server (DOM Skimming Data Collection)
  lab2-c2-server:
    build:
      context: ./labs/02-dom-skimming
      dockerfile: Dockerfile.c2
    container_name: lab2-dom-c2-server
    networks:
      - labs-network
    volumes:
      - ./labs/02-dom-skimming/malicious-code/stolen-data:/app/stolen-data
    environment:
      - NODE_ENV=development
      - PORT=3000
    depends_on:
      - traefik
    labels:
      - "lab=lab2-dom-skimming"
      - "component=c2-server"
      - "traefik.enable=true"
      - "traefik.http.routers.lab2-c2.rule=PathPrefix(`/lab2/c2`)"
      - "traefik.http.routers.lab2-c2.priority=300"
      - "traefik.http.routers.lab2-c2.entrypoints=web"
      - "traefik.http.routers.lab2-c2.middlewares=lab2-auth-check@file,strip-lab2-c2-prefix@file"
      - "traefik.http.services.lab2-c2-server.loadbalancer.server.port=3000"

  # =============================================================================
  # LAB 3: BROWSER EXTENSION HIJACKING
  # =============================================================================

  # Lab 3 - Vulnerable Site
  lab3-vulnerable-site:
    build: ./labs/03-extension-hijacking/vulnerable-site
    container_name: lab3-vulnerable-site
    networks:
      - labs-network
    depends_on:
      - traefik
    labels:
      - "lab=lab3-extension-hijacking"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab3-main.rule=PathPrefix(`/lab3`)"
      - "traefik.http.routers.lab3-main.priority=200"
      - "traefik.http.routers.lab3-main.entrypoints=web"
      - "traefik.http.routers.lab3-main.middlewares=lab3-auth-check@file,strip-lab3-prefix@file"
      - "traefik.http.services.lab3-vulnerable-site.loadbalancer.server.port=80"

  # Lab 3 - Extension Data Server
  lab3-extension-server:
    build:
      context: ./labs/03-extension-hijacking/test-server
      dockerfile: Dockerfile
    container_name: lab3-extension-server
    networks:
      - labs-network
    environment:
      - NODE_ENV=development
      - PORT=3000
    depends_on:
      - traefik
    labels:
      - "lab=lab3-extension-hijacking"
      - "component=extension-server"
      - "traefik.enable=true"
      - "traefik.http.routers.lab3-extension.rule=PathPrefix(`/lab3/extension`)"
      - "traefik.http.routers.lab3-extension.priority=300"
      - "traefik.http.routers.lab3-extension.entrypoints=web"
      - "traefik.http.routers.lab3-extension.middlewares=lab3-auth-check@file,strip-lab3-extension-prefix@file"
      - "traefik.http.services.lab3-extension-server.loadbalancer.server.port=3000"

  # =============================================================================
  # LAB VARIANTS (Optional - Advanced Scenarios)
  # =============================================================================

  # Lab 1 Variant - Event Listener Variant
  lab1-event-listener-variant:
    build: ./labs/01-basic-magecart/variants/event-listener-variant/vulnerable-site
    container_name: lab1-event-listener-variant
    networks:
      - labs-network
    environment:
      - SKIMMER_VARIANT=event-listener
    volumes:
      - ./labs/01-basic-magecart/variants/event-listener-variant/vulnerable-site:/usr/share/nginx/html:ro
    depends_on:
      - traefik
    labels:
      - "lab=lab1-basic-magecart"
      - "variant=event-listener"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab1-event-listener.rule=PathPrefix(`/lab1/variants/event-listener`)"
      - "traefik.http.routers.lab1-event-listener.priority=400"
      - "traefik.http.routers.lab1-event-listener.entrypoints=web"
      - "traefik.http.routers.lab1-event-listener.middlewares=lab1-auth-check@file,strip-lab1-event-listener-prefix@file"
      - "traefik.http.services.lab1-event-listener-variant.loadbalancer.server.port=80"

  # Lab 1 Variant - Obfuscated Base64 Variant
  lab1-obfuscated-variant:
    build: ./labs/01-basic-magecart/variants/obfuscated-base64/vulnerable-site
    container_name: lab1-obfuscated-variant
    networks:
      - labs-network
    environment:
      - SKIMMER_VARIANT=obfuscated-base64
    volumes:
      - ./labs/01-basic-magecart/variants/obfuscated-base64/vulnerable-site:/usr/share/nginx/html:ro
    depends_on:
      - traefik
    labels:
      - "lab=lab1-basic-magecart"
      - "variant=obfuscated-base64"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab1-obfuscated.rule=PathPrefix(`/lab1/variants/obfuscated`)"
      - "traefik.http.routers.lab1-obfuscated.priority=400"
      - "traefik.http.routers.lab1-obfuscated.entrypoints=web"
      - "traefik.http.routers.lab1-obfuscated.middlewares=lab1-auth-check@file,strip-lab1-obfuscated-prefix@file"
      - "traefik.http.services.lab1-obfuscated-variant.loadbalancer.server.port=80"

  # Lab 1 Variant - WebSocket Exfiltration
  lab1-websocket-variant:
    build: ./labs/01-basic-magecart/variants/websocket-exfil/vulnerable-site
    container_name: lab1-websocket-variant
    networks:
      - labs-network
    environment:
      - SKIMMER_VARIANT=websocket-exfil
    volumes:
      - ./labs/01-basic-magecart/variants/websocket-exfil/vulnerable-site:/usr/share/nginx/html:ro
    depends_on:
      - traefik
    labels:
      - "lab=lab1-basic-magecart"
      - "variant=websocket-exfil"
      - "component=vulnerable-site"
      - "traefik.enable=true"
      - "traefik.http.routers.lab1-websocket.rule=PathPrefix(`/lab1/variants/websocket`)"
      - "traefik.http.routers.lab1-websocket.priority=400"
      - "traefik.http.routers.lab1-websocket.entrypoints=web"
      - "traefik.http.routers.lab1-websocket.middlewares=lab1-auth-check@file,strip-lab1-websocket-prefix@file"
      - "traefik.http.services.lab1-websocket-variant.loadbalancer.server.port=80"

# =============================================================================
# NETWORKS
# =============================================================================
networks:
  labs-network:
    driver: bridge
    name: e-skimming-labs-network

# =============================================================================
# VOLUMES
# =============================================================================
volumes:
  lab1-stolen-data:
    driver: local
  lab2-stolen-data:
    driver: local
  lab3-stolen-data:
    driver: local
