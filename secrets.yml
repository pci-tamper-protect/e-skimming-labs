# E-Skimming Labs Secrets
# This file documents secrets with their source and all storage locations
# Reference counting: Original source + all downstream stores
# Entry key name: Source material identifier
# stores: list all places where this secret is stored
# Note: The secret value is the same in source and stores, so hash only at source level

secrets:
  GCP_LABS_SA_KEY:
    source: gcp.iam
    source_account: github-actions@labs-prd.iam.gserviceaccount.com
    source_project: labs-prd
    description: "Service account key for labs-prd project"
    source_read_cmd: "To populate hash, download key: gcloud iam service-accounts keys create labs-prd-key.json --iam-account=github-actions@labs-prd.iam.gserviceaccount.com --project=labs-prd"
    source_hash: "To be updated after downloading key file"
    stores:
      - store: github
        name: GCP_LABS_SA_KEY
        repo: pci-tamper-protect/e-skimming-labs
        fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
        read_cmd: "secret_value_read_not_allowed"
        rotation_notes: "Rotate key, then update secret in GitHub"
    
  GCP_HOME_SA_KEY:
    source: gcp.iam
    source_account: github-actions@labs-home-prd.iam.gserviceaccount.com
    source_project: labs-home-prd
    description: "Service account key for labs-home-prd project"
    source_read_cmd: "To populate hash, download key: gcloud iam service-accounts keys create labs-home-prd-key.json --iam-account=github-actions@labs-home-prd.iam.gserviceaccount.com --project=labs-home-prd"
    source_hash: "To be updated after downloading key file"
    stores:
      - store: github
        name: GCP_HOME_SA_KEY
        repo: pci-tamper-protect/e-skimming-labs
        fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
        read_cmd: "secret_value_read_not_allowed"
        rotation_notes: "Rotate key, then update secret in GitHub"

# Key Rotation Notes
key_rotation:
  when_to_rotate: "Quarterly or after any security incident"
  
  process:
    - step: "Create new key"
      command: "gcloud iam service-accounts keys create [NEW-KEY.json] --iam-account=[EMAIL] --project=[PROJECT]"
    - step: "Update GitHub secrets"
      command: "gh secret set GCP_LABS_SA_KEY --body \"$(cat [NEW-KEY.json] | base64)\" --repo pci-tamper-protect/e-skimming-labs"
    - step: "Wait for successful deployment"
      notes: "Wait for GitHub Actions workflow to succeed with new key"
    - step: "Delete old key"
      command: "gcloud iam service-accounts keys delete [KEY_ID] --iam-account=[EMAIL] --project=[PROJECT]"
  
  secret_locations:
    - "GitHub Secrets (GCP_LABS_SA_KEY)"
    - "GitHub Secrets (GCP_HOME_SA_KEY)"
    - "Local key files (if any exist)"
