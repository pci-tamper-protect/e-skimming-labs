# E-Skimming Labs Secrets
# This file documents secrets with hashed/masked values and retrieval commands

# Labs Project Service Account
labs_project_sa:
  account_name: github-actions
  account_email: github-actions@labs-prd.iam.gserviceaccount.com
  project_id: labs-prd
  description: "Service account for GitHub Actions deployments in labs-prd"

  roles:
    - role: roles/run.admin
      description: "Deploy and manage Cloud Run services"
    - role: roles/artifactregistry.writer
      description: "Push Docker images to Artifact Registry"
    - role: roles/iam.serviceAccountUser
      description: "Act as Cloud Run service accounts"
    - role: roles/artifactregistry.reader
      description: "Pull golden base images from pcioasis-operations"
      scope: cross-project
      target_project: pcioasis-operations

  github_secrets:
    - name: GCP_LABS_SA_KEY
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GCP_LABS_SA_KEY --repo pci-tamper-protect/e-skimming-labs
      description: "Service account key for labs-prd project"
      is_secret: true
      rotation_notes: "Rotate key, then update secret in GitHub"

    - name: GCP_LABS_PROJECT_ID
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GCP_LABS_PROJECT_ID --repo pci-tamper-protect/e-skimming-labs
      description: "Labs project ID"
      value: labs-prd

    - name: GAR_LABS_LOCATION
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GAR_LABS_LOCATION --repo pci-tamper-protect/e-skimming-labs
      description: "Labs project Artifact Registry location"
      value: us-central1

    - name: REPOSITORY_LABS
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get REPOSITORY_LABS --repo pci-tamper-protect/e-skimming-labs
      description: "Labs project Artifact Registry repository name"
      value: lab-images

# Home Project Service Account
home_project_sa:
  account_name: github-actions
  account_email: github-actions@labs-home-prd.iam.gserviceaccount.com
  project_id: labs-home-prd
  description: "Service account for GitHub Actions deployments in labs-home-prd"

  roles:
    - role: roles/run.admin
      description: "Deploy and manage Cloud Run services"
    - role: roles/artifactregistry.writer
      description: "Push Docker images to Artifact Registry"
    - role: roles/iam.serviceAccountUser
      description: "Act as Cloud Run service accounts"
    - role: roles/artifactregistry.reader
      description: "Pull golden base images from pcioasis-operations"
      scope: cross-project
      target_project: pcioasis-operations

  github_secrets:
    - name: GCP_HOME_SA_KEY
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GCP_HOME_SA_KEY --repo pci-tamper-protect/e-skimming-labs
      description: "Service account key for labs-home-prd project"
      is_secret: true
      rotation_notes: "Rotate key, then update secret in GitHub"

    - name: GCP_HOME_PROJECT_ID
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GCP_HOME_PROJECT_ID --repo pci-tamper-protect/e-skimming-labs
      description: "Home project ID"
      value: labs-home-prd

    - name: GAR_HOME_LOCATION
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get GAR_HOME_LOCATION --repo pci-tamper-protect/e-skimming-labs
      description: "Home project Artifact Registry location"
      value: us-central1

    - name: REPOSITORY_HOME
      repo: pci-tamper-protect/e-skimming-labs
      fqdn: https://github.com/pci-tamper-protect/e-skimming-labs/settings/secrets/actions
      read_cmd: gh secret get REPOSITORY_HOME --repo pci-tamper-protect/e-skimming-labs
      description: "Home project Artifact Registry repository name"
      value: home-images

# Key Rotation Notes
key_rotation:
  when_to_rotate: "Quarterly or after any security incident"

  process:
    - step: "Create new key"
      command: "gcloud iam service-accounts keys create [NEW-KEY.json] --iam-account=[EMAIL] --project=[PROJECT]"

    - step: "Update GitHub secrets"
      command: "gh secret set GCP_LABS_SA_KEY --body \"\$(cat [NEW-KEY.json] | base64)\" --repo pci-tamper-protect/e-skimming-labs"

    - step: "Wait for successful deployment"
      notes: "Wait for GitHub Actions workflow to succeed with new key"

    - step: "Delete old key"
      command: "gcloud iam service-accounts keys delete [KEY_ID] --iam-account=[EMAIL] --project=[PROJECT]"

  secret_locations:
    - "GitHub Secrets (GCP_LABS_SA_KEY)"
    - "GitHub Secrets (GCP_HOME_SA_KEY)"
    - "Local key files (if any exist)"
