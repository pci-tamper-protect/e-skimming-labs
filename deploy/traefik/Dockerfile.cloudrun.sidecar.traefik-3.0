# Traefik Dockerfile for Google Cloud Run (Sidecar Architecture) - Traefik v3.0
# Main Traefik container: serves web traffic only, reads routes.yml from shared volume
# Provider sidecar generates routes.yml into shared volume
# Dashboard sidecar serves dashboard UI separately
# 
# This is the Traefik v3.0 version. For v2.10 (stable), use Dockerfile.cloudrun.sidecar

FROM traefik:v3.0

# Install curl for health checks and su-exec for user switching
USER root
RUN apk add --no-cache curl ca-certificates bash su-exec

# Copy Traefik configuration (sidecar version - no plugin, uses file provider)
# Routes are generated by provider sidecar into /shared/traefik/dynamic
RUN mkdir -p /etc/traefik/dynamic /shared/traefik/dynamic
COPY traefik.cloudrun.sidecar.traefik-3.0.yml /etc/traefik/traefik.yml
# Copy static middlewares file - these are referenced by provider-generated routes
# The provider generates routes.yml with routers/services, this file provides middlewares
COPY dynamic/routes.yml /etc/traefik/dynamic/middlewares.yml
# Ensure config file is readable
RUN chmod 644 /etc/traefik/traefik.yml && \
    chmod 644 /etc/traefik/dynamic/middlewares.yml && \
    chmod -R 755 /shared/traefik/dynamic && \
    echo "✅ Traefik config files ready"

# Create traefik user (non-root for security)
RUN addgroup -g 1000 traefik && \
    adduser -D -u 1000 -G traefik traefik && \
    chown -R traefik:traefik /shared/traefik && \
    echo "✅ traefik user created"

# Copy entrypoint script for better logging (Traefik 3.0 specific)
COPY entrypoint-sidecar.traefik-3.0.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Note: Entrypoint runs as root initially to copy middlewares,
# then switches to traefik user before exec'ing Traefik
USER root

# Expose ports
EXPOSE 8080

# Health check
HEALTHCHECK --interval=10s --timeout=3s --retries=3 \
    CMD traefik healthcheck --ping || exit 1

# Use entrypoint script for better startup logging
ENTRYPOINT ["/entrypoint.sh"]
CMD ["traefik"]
