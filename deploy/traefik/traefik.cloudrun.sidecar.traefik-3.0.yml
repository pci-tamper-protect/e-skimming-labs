# Traefik Static Configuration for Google Cloud Run (Sidecar Architecture) - Traefik v3.0
# Main Traefik container: serves web traffic only, no dashboard
# Dashboard is served by a separate sidecar container
#
# Traefik v3.0 differences from v2.10:
# - No auto-creation of "traefik" entrypoint when api.insecure: true
# - Slightly different config syntax for some options
# - Better performance and newer features

# Entry points
# Cloud Run requires binding to 0.0.0.0 (not just :port)
# Only one entrypoint should use port 8080 (Cloud Run's exposed port)
entryPoints:
  web:
    address: "0.0.0.0:8080"  # Cloud Run uses port 8080, must bind to 0.0.0.0
    # No HTTP to HTTPS redirect as Cloud Run handles HTTPS termination
    forwardedHeaders:
      # Trust localhost so ForwardAuth loopback (localhost→Traefik→home-index) preserves
      # X-Forwarded-Uri. Without this, Traefik strips forwarded headers from untrusted IPs,
      # causing X-Forwarded-Uri to be empty at the auth handler, which breaks post-login
      # redirects (users land at /api/auth/check instead of the original lab URL).
      trustedIPs:
        - "127.0.0.1/8"
        - "::1"

# Providers - File provider reads routes.yml from shared volume (generated by provider sidecar)
providers:
  file:
    directory: /shared/traefik/dynamic
    watch: true

# API Configuration
# Enable API for dashboard sidecar to access stats
# Dashboard sidecar will connect to this API on localhost:8080
# In Traefik v3.0, api.insecure: true no longer auto-creates a "traefik" entrypoint
api:
  dashboard: false  # Dashboard is served by sidecar, not main container
  insecure: false   # Disable insecure API - use dynamic routes via api@internal service

# Logging
log:
  level: DEBUG  # DEBUG for troubleshooting startup issues
  format: json

# Access logs for Cloud Run
accessLog:
  format: json
  fields:
    defaultMode: keep
    headers:
      defaultMode: keep
      names:
        User-Agent: keep
        X-Forwarded-For: keep
        X-Forwarded-Proto: keep
        X-Cloud-Trace-Context: keep
        Authorization: keep

# Metrics for Cloud Monitoring
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    entryPoint: web  # Serve metrics on web entrypoint (port 8080)

# Health check endpoint
ping:
  entryPoint: web

# Global settings
global:
  checkNewVersion: false  # Disable in production
  sendAnonymousUsage: false
