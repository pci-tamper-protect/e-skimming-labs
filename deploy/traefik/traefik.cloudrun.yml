# Traefik Static Configuration for Google Cloud Run
# This configuration uses environment variables to discover backend services

# Entry points
entryPoints:
  web:
    address: ":8080"  # Cloud Run uses port 8080 (only port exposed)
    # No HTTP to HTTPS redirect as Cloud Run handles HTTPS termination
    # Note: forwarded-headers middleware is applied per-router, not at entrypoint level

# Providers - Cloud Run plugin for dynamic service discovery
# Local plugin mode: plugin source code is in ./plugins-local/src/github.com/pci-tamper-protect/traefik-cloudrun-provider
experimental:
  localPlugins:
    cloudrun:
      moduleName: github.com/pci-tamper-protect/traefik-cloudrun-provider

providers:
  plugin:
    cloudrun:
      # Configuration is loaded from environment variables:
      # - LABS_PROJECT_ID (required)
      # - HOME_PROJECT_ID (optional)
      # - REGION (defaults to us-central1)
      # - LOG_LEVEL (defaults to INFO)
      # - LOG_FORMAT (defaults to text)
      pollInterval: 30s
      ruleMap:
        home-index-root: "PathPrefix(`/`)"
        home-index-signin: "Path(`/sign-in`) || Path(`/sign-up`)"
        home-seo: "PathPrefix(`/api/seo`)"
        labs-analytics: "PathPrefix(`/api/analytics`)"
        lab1: "PathPrefix(`/lab1`)"
        lab1-main: "PathPrefix(`/lab1`)"
        lab1-static: "PathPrefix(`/lab1/css/`) || PathPrefix(`/lab1/js/`) || PathPrefix(`/lab1/images/`) || PathPrefix(`/lab1/img/`) || PathPrefix(`/lab1/static/`) || PathPrefix(`/lab1/assets/`)"
        lab1-c2: "PathPrefix(`/lab1/c2`)"
        lab2: "PathPrefix(`/lab2`)"
        lab2-main: "PathPrefix(`/lab2`)"
        lab2-static: "PathPrefix(`/lab2/css/`) || PathPrefix(`/lab2/js/`) || PathPrefix(`/lab2/images/`) || PathPrefix(`/lab2/img/`) || PathPrefix(`/lab2/static/`) || PathPrefix(`/lab2/assets/`)"
        lab2-c2: "PathPrefix(`/lab2/c2`)"
        lab3: "PathPrefix(`/lab3`)"
        lab3-main: "PathPrefix(`/lab3`)"
        lab3-static: "PathPrefix(`/lab3/css/`) || PathPrefix(`/lab3/js/`) || PathPrefix(`/lab3/images/`) || PathPrefix(`/lab3/img/`) || PathPrefix(`/lab3/static/`) || PathPrefix(`/lab3/assets/`)"
        lab3-extension: "PathPrefix(`/lab3/extension`)"
        lab4: "PathPrefix(`/lab4`)"
        lab4-static: "PathPrefix(`/lab4/css/`) || PathPrefix(`/lab4/js/`) || PathPrefix(`/lab4/images/`) || PathPrefix(`/lab4/img/`) || PathPrefix(`/lab4/static/`) || PathPrefix(`/lab4/assets/`)"
        lab4-c2: "PathPrefix(`/lab4/c2`)"
  # Keep file provider for static middlewares (retry-cold-start, etc.)
  file:
    directory: /etc/traefik/dynamic
    watch: true

# API and Dashboard
# Serve API and dashboard on the same port (8080) as web traffic
# When insecure: false, we need to create explicit routes in dynamic/routes.yml
# to expose the API and dashboard via the api@internal service
# Note: When insecure: false, do NOT set api.entryPoint in static config.
# The entryPoints are specified in the dynamic routes to api@internal instead.
api:
  dashboard: true
  insecure: false
  # entryPoint is NOT set here when insecure: false
  # EntryPoints are specified in dynamic routes to api@internal

# Logging
log:
  level: DEBUG  # Increased to DEBUG for troubleshooting auth issues
  format: json

# Access logs for Cloud Run
accessLog:
  format: json
  fields:
    defaultMode: keep
    headers:
      defaultMode: keep
      names:
        User-Agent: keep
        X-Forwarded-For: keep
        X-Forwarded-Proto: keep
        X-Cloud-Trace-Context: keep
        Authorization: keep  # Log Authorization header for debugging

# Metrics for Cloud Monitoring
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    entryPoint: web  # Serve metrics on web entrypoint (port 8080)

# Health check endpoint
ping:
  entryPoint: web

# Global settings
global:
  checkNewVersion: false  # Disable in production
  sendAnonymousUsage: false
