# Traefik Dynamic Configuration - Middlewares Only
# This file defines middlewares for use by both Docker and File providers
#
# For local development (Docker Compose):
#   - Routers and services are defined via Docker labels in docker-compose.yml
#   - Middlewares are defined here and referenced with @file suffix
#
# For Cloud Run (File provider only):
#   - Routers, services, and middlewares are generated by entrypoint.sh
#   - This file provides the middleware definitions

http:
  # Middlewares modify requests/responses
  middlewares:
    # Strip /api/seo prefix before forwarding
    strip-seo-prefix:
      stripPrefix:
        prefixes:
          - "/api/seo"

    # Strip /api/analytics prefix before forwarding
    strip-analytics-prefix:
      stripPrefix:
        prefixes:
          - "/api/analytics"

    # Lab 1 middlewares
    # Auth check middleware - forwards to home-index-service to verify authentication
    lab1-auth-check:
      forwardAuth:
        address: "http://home-index:8080/api/auth/check"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Email"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
        trustForwardHeader: true

    strip-lab1-prefix:
      stripPrefix:
        prefixes:
          - "/lab1"

    strip-lab1-c2-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/c2"

    strip-lab1-event-listener-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/event-listener"

    strip-lab1-obfuscated-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/obfuscated"

    strip-lab1-websocket-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/websocket"

    # Lab 2 middlewares
    # Auth check middleware - forwards to home-index-service to verify authentication
    lab2-auth-check:
      forwardAuth:
        address: "http://home-index:8080/api/auth/check"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Email"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
        trustForwardHeader: true

    strip-lab2-prefix:
      stripPrefix:
        prefixes:
          - "/lab2"

    strip-lab2-c2-prefix:
      stripPrefix:
        prefixes:
          - "/lab2/c2"

    # Lab 3 middlewares
    # Auth check middleware - forwards to home-index-service to verify authentication
    lab3-auth-check:
      forwardAuth:
        address: "http://home-index:8080/api/auth/check"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Email"
        authRequestHeaders:
          - "Authorization"
          - "Cookie"
        trustForwardHeader: true

    strip-lab3-prefix:
      stripPrefix:
        prefixes:
          - "/lab3"

    strip-lab3-extension-prefix:
      stripPrefix:
        prefixes:
          - "/lab3/extension"

    # Security headers
    security-headers:
      headers:
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
        sslRedirect: false  # Set to true for production

    # Rate limiting (optional, can be enabled per route)
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1m

  # Services are discovered automatically via Docker provider in local development
  # Service definitions are only needed for Cloud Run (file provider only)
  # For local development, Docker labels on containers define the services
  # See docker-compose.yml for service label definitions
