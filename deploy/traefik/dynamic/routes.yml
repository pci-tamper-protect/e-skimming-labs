# Traefik Dynamic Configuration - Middlewares and Static Routes
# This file defines middlewares and static routes (like Traefik API) for use by both Docker and File providers
#
# For local development (Docker Compose):
#   - Routers and services are defined via Docker labels in docker-compose.yml
#   - Middlewares are defined here and referenced with @file suffix
#
# For Cloud Run (File provider only):
#   - Routers, services, and middlewares are generated by plugin or entrypoint.sh
#   - This file provides the middleware definitions and static API routes

http:
  # Static routers - always available regardless of plugin status
  routers:
    # Traefik API and Dashboard routers (high priority to match before application routes)
    # These routes expose Traefik's internal API and dashboard on port 8080
    # Based on: https://community.traefik.io/t/serving-traefiks-internal-dashboard-behind-traefik-itself/3457/7
    # When insecure: false, we must create explicit routes to api@internal
    # API: /api/http/*, /api/rawdata/*, /api/overview, etc.
    # Dashboard: /dashboard/
    traefik-api:
      rule: "PathPrefix(`/api/http`) || PathPrefix(`/api/rawdata`) || PathPrefix(`/api/overview`) || Path(`/api/version`)"
      service: api@internal
      priority: 1000  # High priority to match before application /api/* routes (seo=500, analytics=500)
      entryPoints:
        - web
    traefik-dashboard:
      rule: "PathPrefix(`/dashboard`)"
      service: api@internal
      priority: 1000  # High priority
      entryPoints:
        - web

  # Middlewares modify requests/responses
  middlewares:
    # Note: forwardedHeaders configuration belongs in entryPoints (static config), not in middleware.
    # The forwardedHeaders trust configuration is in traefik.yml entryPoints section.
    # If forwarded-headers@file is referenced in labels, those references should be removed
    # or replaced with a valid headers middleware if needed.

    # Forwarded headers middleware - ensures X-Forwarded-Host and X-Forwarded-For are forwarded
    # Traefik v2.10 automatically forwards these headers, but this middleware ensures they're set correctly
    # for services that need to detect proxy access (like home-index service)
    # Note: In Traefik v2.10, X-Forwarded-Host is automatically set to the client's Host header
    # This middleware mainly sets X-Forwarded-Proto for Cloud Run services
    # Also sets X-Forwarded-For to include localhost for local proxy detection
    forwarded-headers:
      headers:
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          # Add localhost to X-Forwarded-For chain to help home-index detect local proxy
          # This is appended to the existing X-Forwarded-For header by Traefik
          # Note: Traefik automatically forwards X-Forwarded-Host (e.g., localhost:9090)
        # Note: X-Forwarded-Host and X-Forwarded-For are automatically forwarded by Traefik
        # X-Forwarded-Host will be set to the original client Host (e.g., localhost:9090)
        # This allows home-index service to detect it's behind Traefik by checking X-Forwarded-Host

    # Strip /api/seo prefix before forwarding
    strip-seo-prefix:
      stripPrefix:
        prefixes:
          - "/api/seo"

    # Strip /api/analytics prefix before forwarding
    strip-analytics-prefix:
      stripPrefix:
        prefixes:
          - "/api/analytics"

    # Lab 1 middlewares
    # Note: lab1-auth-check is defined in local-auth-stubs.yml for local dev (empty chain)
    # and generated by traefik-cloudrun-provider for Cloud Run (real ForwardAuth).

    strip-lab1-prefix:
      stripPrefix:
        prefixes:
          - "/lab1"

    strip-lab1-c2-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/c2"

    strip-lab1-event-listener-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/event-listener"

    strip-lab1-obfuscated-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/obfuscated"

    strip-lab1-websocket-prefix:
      stripPrefix:
        prefixes:
          - "/lab1/variants/websocket"

    # Lab 2 middlewares
    # Note: lab2-auth-check is defined in local-auth-stubs.yml for local dev.

    strip-lab2-prefix:
      stripPrefix:
        prefixes:
          - "/lab2"

    strip-lab2-c2-prefix:
      stripPrefix:
        prefixes:
          - "/lab2/c2"

    # Lab 3 middlewares
    # Note: lab3-auth-check is defined in local-auth-stubs.yml for local dev.

    strip-lab3-prefix:
      stripPrefix:
        prefixes:
          - "/lab3"

    strip-lab3-extension-prefix:
      stripPrefix:
        prefixes:
          - "/lab3/extension"

    # Lab 4 middlewares
    # Note: lab4-auth-check is defined in local-auth-stubs.yml for local dev.

    strip-lab4-prefix:
      stripPrefix:
        prefixes:
          - "/lab4"

    strip-lab4-c2-prefix:
      stripPrefix:
        prefixes:
          - "/lab4/c2"

    # Security headers
    security-headers:
      headers:
        customResponseHeaders:
          X-Frame-Options: "SAMEORIGIN"
          X-Content-Type-Options: "nosniff"
          X-XSS-Protection: "1; mode=block"
        sslRedirect: false  # Set to true for production

    # Sign-in page headers - Allow cross-origin popups for Firebase authentication
    signin-headers:
      headers:
        customResponseHeaders:
          Cross-Origin-Opener-Policy: "same-origin-allow-popups"
          Cross-Origin-Embedder-Policy: "unsafe-none"

    # Rate limiting (optional, can be enabled per route)
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1m

    # Retry middleware for handling cold starts
    # Retries failed requests with exponential backoff
    # Supports Cloud Run services that scale to zero
    retry-cold-start:
      retry:
        attempts: 3

  # Services and routers are generated from:
  # - Docker labels (local development via Docker provider)
  # - Cloud Run service labels (Cloud Run via traefik-cloudrun-provider)
  #
  # This file only contains middlewares.
  # Routers and services are auto-discovered from labels.
