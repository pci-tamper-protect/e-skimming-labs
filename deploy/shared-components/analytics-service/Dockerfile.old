FROM golang:1.25-alpine AS builder

WORKDIR /app

# Copy go.mod and go.sum first for better caching
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Update go.mod if needed (required when Go version changes)
RUN go mod tidy

# Build the application
RUN CGO_ENABLED=0 GOOS=linux go build -o analytics-service main.go

FROM alpine:3.23
WORKDIR /app

# Create non-root user
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

COPY --from=builder /app/analytics-service .
RUN chown -R appuser:appuser /app
USER appuser

EXPOSE 8080
CMD ["./analytics-service"]
