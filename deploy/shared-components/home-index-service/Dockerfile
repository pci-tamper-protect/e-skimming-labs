# Optimized Dockerfile using golden base image
# Uses pcioasis-operations/containers/go-base for better caching
# Note: This service is built from the repo root, not from the service directory

# Declare build arguments at the top
ARG BASE_IMAGE=us-central1-docker.pkg.dev/pcioasis-operations/containers/go-base:latest
ARG ALPINE_BASE=us-central1-docker.pkg.dev/pcioasis-operations/containers/alpine-base:latest

FROM ${BASE_IMAGE} AS builder

# Set working directory
WORKDIR /app

# Copy go.mod and go.sum from the home-index-service directory
COPY deploy/shared-components/home-index-service/go.mod ./
# Copy go.sum if it exists (wildcard won't fail if file doesn't exist)
COPY deploy/shared-components/home-index-service/go.sum* ./

# Download dependencies (will use cached modules from base image)
RUN go mod download

# Copy source code from the home-index-service directory
COPY deploy/shared-components/home-index-service/ .

# Update go.mod if needed
RUN go mod tidy

# Build the application
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Final stage using alpine-base
FROM ${ALPINE_BASE} AS runtime

# Create app directory
WORKDIR /app

# Copy the binary from builder stage
COPY --from=builder /app/main .

# Copy the docs directory for MITRE ATT&CK and threat model pages
COPY docs ./docs

# Copy lab README files from their original locations
# Uses stable filenames: Lab01-README.md, Lab02-README.md, Lab03-README.md
COPY labs/ ./labs-temp/
RUN mkdir -p ./docs/labs/01-basic-magecart ./docs/labs/02-dom-skimming ./docs/labs/03-extension-hijacking && \
    cp ./labs-temp/01-basic-magecart/Lab01-README.md ./docs/labs/01-basic-magecart/README.md 2>/dev/null || true && \
    cp ./labs-temp/02-dom-skimming/Lab02-README.md ./docs/labs/02-dom-skimming/README.md 2>/dev/null || true && \
    cp ./labs-temp/03-extension-hijacking/Lab03-README.md ./docs/labs/03-extension-hijacking/README.md 2>/dev/null || true && \
    rm -rf ./labs-temp

# Copy catalog info for service metadata
# The file must exist in the repo root (build context is .)
# It should be generated by scripts/generate-catalog-info.sh before building
# This will fail if catalog-info.yaml is not present - ensure it's generated in CI/CD
COPY catalog-info.yaml ./catalog-info.yaml

# Set ownership (alpine-base already has appuser)
RUN chown -R appuser:appuser /app
USER appuser

# Expose port
EXPOSE 8080

# Health check (alpine-base has wget pre-installed)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# Run the application
CMD ["./main"]

