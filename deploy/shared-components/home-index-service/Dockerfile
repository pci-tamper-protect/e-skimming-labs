# Optimized Dockerfile using golden base image
# Uses pcioasis-operations/containers/go-base for better caching
# Note: This service is built from the repo root, not from the service directory

# Declare build arguments at the top
ARG BASE_IMAGE=us-central1-docker.pkg.dev/pcioasis-operations/containers/go-base:latest
ARG ALPINE_BASE=us-central1-docker.pkg.dev/pcioasis-operations/containers/alpine-base:latest

FROM ${BASE_IMAGE} AS builder

# Set working directory
WORKDIR /app

# Copy go.mod and go.sum from the home-index-service directory
COPY deploy/shared-components/home-index-service/go.mod ./
# Copy go.sum if it exists (wildcard won't fail if file doesn't exist)
COPY deploy/shared-components/home-index-service/go.sum* ./

# Download dependencies (will use cached modules from base image)
RUN go mod download

# Copy source code from the home-index-service directory
COPY deploy/shared-components/home-index-service/ .

# Update go.mod if needed
RUN go mod tidy

# Build the application
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

# Final stage using alpine-base
FROM ${ALPINE_BASE} AS runtime

# Create app directory
WORKDIR /app

# Copy the binary from builder stage
COPY --from=builder /app/main .

# Copy the docs directory for MITRE ATT&CK and threat model pages
COPY docs ./docs

# Copy lab README files from their original locations
# Prefers LabXX-README.md naming convention, falls back to README.md
# Structure: labs/{lab-id}/LabXX-README.md or README.md -> docs/labs/{lab-id}/README.md
COPY labs/ ./labs-temp/
RUN mkdir -p ./docs/labs && \
    for lab_dir in ./labs-temp/*/; do \
      if [ -d "$lab_dir" ]; then \
        lab_name=$(basename "$lab_dir"); \
        readme_file="" && \
        # Prefer LabXX-README.md naming convention
        if [ -f "$lab_dir/Lab01-README.md" ] && [ "$lab_name" = "01-basic-magecart" ]; then \
          readme_file="$lab_dir/Lab01-README.md"; \
        elif [ -f "$lab_dir/Lab02-README.md" ] && [ "$lab_name" = "02-dom-skimming" ]; then \
          readme_file="$lab_dir/Lab02-README.md"; \
        elif [ -f "$lab_dir/Lab03-README.md" ] && [ "$lab_name" = "03-extension-hijacking" ]; then \
          readme_file="$lab_dir/Lab03-README.md"; \
        # Fallback to README.md if LabXX-README.md doesn't exist
        elif [ -f "$lab_dir/README.md" ]; then \
          readme_file="$lab_dir/README.md"; \
        fi && \
        if [ -n "$readme_file" ] && [ -f "$readme_file" ]; then \
          mkdir -p "./docs/labs/$lab_name" && \
          cp "$readme_file" "./docs/labs/$lab_name/README.md" && \
          echo "‚úÖ Copied README for lab: $lab_name from $(basename "$readme_file")"; \
        else \
          echo "‚ö†Ô∏è  Warning: No README found for lab: $lab_name (checked LabXX-README.md and README.md)"; \
        fi; \
      fi; \
    done && \
    rm -rf ./labs-temp && \
    echo "" && \
    echo "üìö Lab README files copied. Contents of /app/docs/labs:" && \
    ls -la ./docs/labs/ && \
    echo "" && \
    echo "üìÑ Verifying all lab READMEs exist:" && \
    for lab in 01-basic-magecart 02-dom-skimming 03-extension-hijacking; do \
      if [ -f "./docs/labs/$lab/README.md" ]; then \
        echo "  ‚úÖ $lab/README.md exists"; \
      else \
        echo "  ‚ùå $lab/README.md MISSING"; \
      fi; \
    done

# Copy catalog info for service metadata
# The file must exist in the repo root (build context is .)
# It should be generated by scripts/generate-catalog-info.sh before building
# This will fail if catalog-info.yaml is not present - ensure it's generated in CI/CD
COPY catalog-info.yaml ./catalog-info.yaml

# Copy entrypoint script
COPY deploy/shared-components/home-index-service/entrypoint.sh ./entrypoint.sh

# Copy environment files for encrypted Firebase credentials
# These files contain dotenvx-encrypted values that will be decrypted at runtime
# using the DOTENVX_KEY mounted from Secret Manager
COPY .env.stg ./.env.stg

# Install dotenvx for decrypting environment variables at runtime
# Install as root before switching to appuser
USER root
RUN apk add --no-cache curl && \
    curl -sfS https://dotenvx.sh/install.sh | sh && \
    apk del curl && \
    chmod +x ./entrypoint.sh

# Set ownership (alpine-base already has appuser)
RUN chown -R appuser:appuser /app
USER appuser

# Expose port
EXPOSE 8080

# Health check (alpine-base has wget pre-installed)
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

# Run the application via entrypoint script
# The entrypoint creates the .env symlink and runs with dotenvx
CMD ["./entrypoint.sh"]
