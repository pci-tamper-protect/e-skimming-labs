name: Deploy CloudRun

on:
  pull_request:
    branches: [main, stg]
    types: [opened, synchronize, reopened]
    paths:
      # Home components
      - 'deploy/shared-components/seo-service/**'
      - 'deploy/shared-components/home-index-service/**'
      - 'deploy/Dockerfile.index'
      # Labs components
      - 'deploy/shared-components/analytics-service/**'
      - 'labs/**'
      - 'deploy/Dockerfile.index'
      # Common files that affect all
      - '.github/workflows/deploy_labs.yml'
    paths-ignore:
      - 'test/**'
      - '**/*.spec.js'
      - '**/playwright.config.js'
      - '**/test/**'
      - 'labs/**/test/**'
      - 'labs/**/README.md'
      - 'labs/**/*.md'
  push:
    branches:
      - 'stg'
      - 'main'
    tags:
      - 'force-all'
      - 'force-home'
      - 'force-labs'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prd'
        type: choice
        options:
          - prd
          - stg

env:
  # Artifact Registry configuration (same for both environments)
  HOME_GAR_LOCATION: "us-central1"
  HOME_REPOSITORY: "e-skimming-labs-home"
  LABS_GAR_LOCATION: "us-central1"
  LABS_REPOSITORY: "e-skimming-labs"
  # Secrets (only service account keys)
  HOME_GCP_SA_KEY: ${{ secrets.GCP_HOME_SA_KEY }}
  LABS_GCP_SA_KEY: ${{ secrets.GCP_LABS_SA_KEY }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      labs: ${{ steps.discover-labs.outputs.labs }}
      environment: ${{ steps.set-env.outputs.environment }}
      domain_prefix: ${{ steps.set-env.outputs.domain_prefix }}
      home_project_id: ${{ steps.set-env.outputs.home_project_id }}
      labs_project_id: ${{ steps.set-env.outputs.labs_project_id }}
      deploy_home: ${{ steps.detect-changes.outputs.deploy_home }}
      deploy_labs: ${{ steps.detect-changes.outputs.deploy_labs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Need full history for change detection

      - name: Detect changes and force tags
        id: detect-changes
        run: |
          # Default: deploy based on what changed
          DEPLOY_HOME="false"
          DEPLOY_LABS="false"
          
          # Check for force tags
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "üîñ Detected tag: $TAG_NAME"
            
            if [[ "$TAG_NAME" == "force-all" ]]; then
              DEPLOY_HOME="true"
              DEPLOY_LABS="true"
              echo "‚úÖ Force deploying all components (force-all)"
            elif [[ "$TAG_NAME" == "force-home" ]]; then
              DEPLOY_HOME="true"
              echo "‚úÖ Force deploying home components (force-home)"
            elif [[ "$TAG_NAME" == "force-labs" ]]; then
              DEPLOY_LABS="true"
              echo "‚úÖ Force deploying labs components (force-labs)"
            fi
          fi
          
          # For PRs and workflow_dispatch, detect changed paths
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "üîç Detecting changes in PR..."
            
            # Get changed files
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^deploy/shared-components/seo-service/\|^deploy/shared-components/home-index-service/\|^deploy/Dockerfile.index"; then
              DEPLOY_HOME="true"
              echo "‚úÖ Home components changed"
            fi
            
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^deploy/shared-components/analytics-service/\|^labs/\|^deploy/Dockerfile.index"; then
              DEPLOY_LABS="true"
              echo "‚úÖ Labs components changed"
            fi
            
            # If workflow file changed, deploy all (safety)
            if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^\.github/workflows/deploy_labs\.yml"; then
              DEPLOY_HOME="true"
              DEPLOY_LABS="true"
              echo "‚úÖ Workflow changed, deploying all"
            fi
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual trigger: deploy all
            DEPLOY_HOME="true"
            DEPLOY_LABS="true"
            echo "‚úÖ Manual trigger, deploying all"
          elif [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" != refs/tags/* ]]; then
            # Push to branch: detect changes
            echo "üîç Detecting changes in push..."
            
            # Check if this commit has a force tag (for feature branches)
            # Tags are checked separately, but we can also check commit message
            COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$COMMIT_MSG" | grep -qi "force-all\|\[force-all\]"; then
              DEPLOY_HOME="true"
              DEPLOY_LABS="true"
              echo "‚úÖ Force deploy detected in commit message (force-all)"
            elif echo "$COMMIT_MSG" | grep -qi "force-home\|\[force-home\]"; then
              DEPLOY_HOME="true"
              echo "‚úÖ Force deploy detected in commit message (force-home)"
            elif echo "$COMMIT_MSG" | grep -qi "force-labs\|\[force-labs\]"; then
              DEPLOY_LABS="true"
              echo "‚úÖ Force deploy detected in commit message (force-labs)"
            else
              # Compare with previous commit
              if git diff --name-only HEAD~1 HEAD | grep -q "^deploy/shared-components/seo-service/\|^deploy/shared-components/home-index-service/\|^deploy/Dockerfile.index"; then
                DEPLOY_HOME="true"
                echo "‚úÖ Home components changed"
              fi
              
              if git diff --name-only HEAD~1 HEAD | grep -q "^deploy/shared-components/analytics-service/\|^labs/\|^deploy/Dockerfile.index"; then
                DEPLOY_LABS="true"
                echo "‚úÖ Labs components changed"
              fi
            fi
          fi
          
          echo "deploy_home=$DEPLOY_HOME" >> $GITHUB_OUTPUT
          echo "deploy_labs=$DEPLOY_LABS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üìã Deployment plan:"
          echo "  Home components: $DEPLOY_HOME"
          echo "  Labs components: $DEPLOY_LABS"

      - name: Set environment variables
        id: set-env
        run: |
          # Determine environment:
          # - For workflow_dispatch: use the input parameter
          # - For pull_request: use the base branch (stg -> stg, main -> prd)
          # - For push/tags: use the target branch (stg -> stg, main -> prd)
          # - Default to prd for safety
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV_INPUT="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PRs against stg branch deploy to STG, PRs against main deploy to PRD
            if [[ "${{ github.base_ref }}" == "stg" ]]; then
              ENV_INPUT="stg"
            else
              ENV_INPUT="prd"
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # Push to stg branch deploys to STG, push to main deploys to PRD
            if [[ "${{ github.ref }}" == "refs/heads/stg" ]]; then
              ENV_INPUT="stg"
            else
              ENV_INPUT="prd"
            fi
          else
            ENV_INPUT="prd"
          fi
          
          if [[ "$ENV_INPUT" == "stg" ]]; then
            echo "environment=stg" >> $GITHUB_OUTPUT
            echo "domain_prefix=labs.stg.pcioasis.com" >> $GITHUB_OUTPUT
            echo "home_project_id=labs-home-stg" >> $GITHUB_OUTPUT
            echo "labs_project_id=labs-stg" >> $GITHUB_OUTPUT
          else
            echo "environment=prd" >> $GITHUB_OUTPUT
            echo "domain_prefix=labs.pcioasis.com" >> $GITHUB_OUTPUT
            echo "home_project_id=labs-home-prd" >> $GITHUB_OUTPUT
            echo "labs_project_id=labs-prd" >> $GITHUB_OUTPUT
          fi
          
          echo "Determined environment: $ENV_INPUT (from ${{ github.event_name }}, ref: ${{ github.ref }}, base_ref: ${{ github.base_ref }})"

      - name: Discover lab directories
        id: discover-labs
        run: |
          # Find all lab directories in labs/ subdirectory
          labs=$(find ./labs -maxdepth 1 -type d -name "*-*" | sed 's|./labs/||' | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "labs=$labs" >> $GITHUB_OUTPUT
          echo "Discovered labs: $labs"

  deploy-home-components:
    needs: setup
    runs-on: ubuntu-latest
    # Skip deployment for Dependabot PRs (secrets not available)
    # Only deploy if home components changed or force tag
    if: (github.event_name != 'pull_request' || github.actor != 'dependabot[bot]') && needs.setup.outputs.deploy_home == 'true'
    env:
      HOME_PROJECT_ID: ${{ needs.setup.outputs.home_project_id }}
      LABS_PROJECT_ID: ${{ needs.setup.outputs.labs_project_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (Home Project)
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.HOME_GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker to use gcloud as credential helper
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          gcloud auth configure-docker ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev
          # Also configure cross-project access for golden images
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if SEO image exists
        id: check-seo-image
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          IMAGE="${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:${{ github.sha }}"
          if gcloud artifacts docker images describe "$IMAGE" --project="${{ env.HOME_PROJECT_ID }}" --location="${{ env.HOME_GAR_LOCATION }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image already exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Image not found, will build: $IMAGE"
          fi

      - name: Build SEO Service
        if: steps.check-seo-image.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: deploy/shared-components/seo-service
          file: deploy/shared-components/seo-service/Dockerfile
          push: false
          tags: |
            ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:${{ github.sha }}
            ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:latest
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Check if Index image exists
        id: check-index-image
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          IMAGE="${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:${{ github.sha }}"
          if gcloud artifacts docker images describe "$IMAGE" --project="${{ env.HOME_PROJECT_ID }}" --location="${{ env.HOME_GAR_LOCATION }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image already exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Image not found, will build: $IMAGE"
          fi

      - name: Build Index Service
        if: steps.check-index-image.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/shared-components/home-index-service/Dockerfile
          push: false
          tags: |
            ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:${{ github.sha }}
            ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:latest
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Push SEO Service to Artifact Registry
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          docker push ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:${{ github.sha }}
          docker push ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:latest

      - name: Push Index Service to Artifact Registry
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null && steps.check-index-image.outputs.exists != 'true'
        run: |
          docker push ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:${{ github.sha }}
          docker push ${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:latest

      - name: Deploy SEO Service to Cloud Run
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          # For staging: Use --no-allow-unauthenticated (IAM groups will be added via Terraform)
          # For production: Use --allow-unauthenticated (public access)
          if [[ "${{ needs.setup.outputs.environment }}" == "stg" ]]; then
            gcloud run deploy home-seo-${{ needs.setup.outputs.environment }} \
              --image=${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:${{ github.sha }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --platform=managed \
              --no-allow-unauthenticated \
              --service-account=home-runtime-sa@${{ env.HOME_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.HOME_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},MAIN_DOMAIN=pcioasis.com,LABS_DOMAIN=${{ needs.setup.outputs.domain_prefix }},LABS_PROJECT_ID=${{ env.LABS_PROJECT_ID }}" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=seo,project=e-skimming-labs-home"
            
            # Grant access to developer groups for staging (Terraform will also manage this)
            echo "Granting access to developer groups for staging SEO service..."
            gcloud run services add-iam-policy-binding home-seo-${{ needs.setup.outputs.environment }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --member="group:2025-interns@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add 2025-interns group access"
            
            gcloud run services add-iam-policy-binding home-seo-${{ needs.setup.outputs.environment }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --member="group:core-eng@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add core-eng group access"
          else
            gcloud run deploy home-seo-${{ needs.setup.outputs.environment }} \
              --image=${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/seo:${{ github.sha }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=home-runtime-sa@${{ env.HOME_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.HOME_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},MAIN_DOMAIN=pcioasis.com,LABS_DOMAIN=${{ needs.setup.outputs.domain_prefix }},LABS_PROJECT_ID=${{ env.LABS_PROJECT_ID }}" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=seo,project=e-skimming-labs-home"
          fi

      - name: Deploy Index Service to Cloud Run
        if: env.HOME_GCP_SA_KEY != '' && env.HOME_GCP_SA_KEY != null
        run: |
          # For staging: Use --no-allow-unauthenticated (IAM groups will be added via Terraform)
          # For production: Use --allow-unauthenticated (public access)
          if [[ "${{ needs.setup.outputs.environment }}" == "stg" ]]; then
            gcloud run deploy home-index-${{ needs.setup.outputs.environment }} \
              --image=${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:${{ github.sha }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --platform=managed \
              --no-allow-unauthenticated \
              --service-account=home-runtime-sa@${{ env.HOME_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.HOME_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},LABS_DOMAIN=${{ needs.setup.outputs.domain_prefix }},MAIN_DOMAIN=pcioasis.com,LABS_PROJECT_ID=${{ env.LABS_PROJECT_ID }},LAB1_URL=https://lab-01-basic-magecart-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app,LAB2_URL=https://lab-02-dom-skimming-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app,LAB3_URL=https://lab-03-extension-hijacking-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=index,project=e-skimming-labs-home"
            
            # Grant access to developer groups for staging (Terraform will also manage this)
            echo "Granting access to developer groups for staging Index service..."
            gcloud run services add-iam-policy-binding home-index-${{ needs.setup.outputs.environment }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --member="group:2025-interns@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add 2025-interns group access"
            
            gcloud run services add-iam-policy-binding home-index-${{ needs.setup.outputs.environment }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --member="group:core-eng@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add core-eng group access"
          else
            gcloud run deploy home-index-${{ needs.setup.outputs.environment }} \
              --image=${{ env.HOME_GAR_LOCATION }}-docker.pkg.dev/${{ env.HOME_PROJECT_ID }}/${{ env.HOME_REPOSITORY }}/index:${{ github.sha }} \
              --region=${{ env.HOME_GAR_LOCATION }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=home-runtime-sa@${{ env.HOME_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.HOME_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},LABS_DOMAIN=${{ needs.setup.outputs.domain_prefix }},MAIN_DOMAIN=pcioasis.com,LABS_PROJECT_ID=${{ env.LABS_PROJECT_ID }},LAB1_URL=https://lab-01-basic-magecart-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app,LAB2_URL=https://lab-02-dom-skimming-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app,LAB3_URL=https://lab-03-extension-hijacking-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=index,project=e-skimming-labs-home"
          fi

  deploy-labs-components:
    needs: setup
    runs-on: ubuntu-latest
    # Skip deployment for Dependabot PRs (secrets not available)
    # Only deploy if labs components changed or force tag
    if: (github.event_name != 'pull_request' || github.actor != 'dependabot[bot]') && needs.setup.outputs.deploy_labs == 'true'
    env:
      HOME_PROJECT_ID: ${{ needs.setup.outputs.home_project_id }}
      LABS_PROJECT_ID: ${{ needs.setup.outputs.labs_project_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (Labs Project)
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.LABS_GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker to use gcloud as credential helper
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          gcloud auth configure-docker ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev
          # Also configure cross-project access for golden images
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if Analytics image exists
        id: check-analytics-image
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          IMAGE="${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:${{ github.sha }}"
          if gcloud artifacts docker images describe "$IMAGE" --project="${{ env.LABS_PROJECT_ID }}" --location="${{ env.LABS_GAR_LOCATION }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image already exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Image not found, will build: $IMAGE"
          fi

      - name: Build Analytics Service
        if: steps.check-analytics-image.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: deploy/shared-components/analytics-service
          file: deploy/shared-components/analytics-service/Dockerfile
          push: false
          tags: |
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:${{ github.sha }}
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:latest
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          load: true

      - name: Push Analytics Service to Artifact Registry
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null && steps.check-analytics-image.outputs.exists != 'true'
        run: |
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:${{ github.sha }}
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:latest

      - name: Deploy Analytics Service to Cloud Run
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          # Analytics service is backend-only (called by lab services)
          # For staging: Use --no-allow-unauthenticated (IAM groups will be added via Terraform)
          # For production: Keep --allow-unauthenticated for service-to-service calls
          # Note: Analytics is typically only called by lab services, not directly by users
          if [[ "${{ needs.setup.outputs.environment }}" == "stg" ]]; then
            gcloud run deploy labs-analytics-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --no-allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.LABS_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},FIRESTORE_DATABASE=(default)" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=analytics,project=e-skimming-labs"
            
            # Grant access to developer groups for staging (Terraform will also manage this)
            echo "Granting access to developer groups for staging Analytics service..."
            gcloud run services add-iam-policy-binding labs-analytics-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:2025-interns@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add 2025-interns group access"
            
            gcloud run services add-iam-policy-binding labs-analytics-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:core-eng@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add core-eng group access"
          else
            gcloud run deploy labs-analytics-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/analytics:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="PROJECT_ID=${{ env.LABS_PROJECT_ID }},ENVIRONMENT=${{ needs.setup.outputs.environment }},FIRESTORE_DATABASE=(default)" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=analytics,project=e-skimming-labs"
          fi

  deploy-labs:
    needs: [setup, deploy-labs-components]
    runs-on: ubuntu-latest
    # Skip deployment for Dependabot PRs (secrets not available)
    # Only deploy if labs components changed or force tag
    if: (github.event_name != 'pull_request' || github.actor != 'dependabot[bot]') && needs.setup.outputs.deploy_labs == 'true'
    env:
      HOME_PROJECT_ID: ${{ needs.setup.outputs.home_project_id }}
      LABS_PROJECT_ID: ${{ needs.setup.outputs.labs_project_id }}
    strategy:
      matrix:
        lab: ${{ fromJson(needs.setup.outputs.labs) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (Labs Project)
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.LABS_GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker to use gcloud as credential helper
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          gcloud auth configure-docker ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev
          # Also configure cross-project access for golden images
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if lab image exists
        id: check-lab-image
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          IMAGE="${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }}"
          if gcloud artifacts docker images describe "$IMAGE" --project="${{ env.LABS_PROJECT_ID }}" --location="${{ env.LABS_GAR_LOCATION }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image already exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Image not found, will build: $IMAGE"
          fi

      - name: Build lab container image
        if: steps.check-lab-image.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: labs/${{ matrix.lab }}
          file: labs/${{ matrix.lab }}/Dockerfile
          push: false
          tags: |
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }}
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:latest
          build-args: |
            LAB_NAME=${{ matrix.lab }}
            ENVIRONMENT=${{ needs.setup.outputs.environment }}
          cache-from: type=gha,scope=lab-${{ matrix.lab }}
          cache-to: type=gha,mode=max,scope=lab-${{ matrix.lab }}
          load: true

      - name: Push container image to Artifact Registry
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null && steps.check-lab-image.outputs.exists != 'true'
        run: |
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }}
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:latest

      - name: Deploy to Cloud Run
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          # Deploy lab as separate Cloud Run service
          # For staging: Use --no-allow-unauthenticated to restrict access (IAM groups will be added via Terraform)
          # For production: Use --allow-unauthenticated for public access
          if [[ "${{ needs.setup.outputs.environment }}" == "stg" ]]; then
            gcloud run deploy lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --no-allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=10 \
              --set-env-vars="LAB_NAME=${{ matrix.lab }},ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},HOME_URL=https://${{ needs.setup.outputs.domain_prefix }},C2_URL=https://lab-${{ matrix.lab }}-c2-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},lab=${{ matrix.lab }},project=e-skimming-labs"
            
            # Grant access to developer groups for staging
            echo "Granting access to developer groups for staging lab..."
            gcloud run services add-iam-policy-binding lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:2025-interns@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add 2025-interns group access"
            
            gcloud run services add-iam-policy-binding lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:core-eng@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add core-eng group access"
          else
            gcloud run deploy lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=10 \
              --set-env-vars="LAB_NAME=${{ matrix.lab }},ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},HOME_URL=https://${{ needs.setup.outputs.domain_prefix }},C2_URL=https://lab-${{ matrix.lab }}-c2-${{ needs.setup.outputs.environment }}-mmwwcfi5za-uc.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},lab=${{ matrix.lab }},project=e-skimming-labs"
          fi

      - name: Configure custom domain mapping
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          # Map custom domain for the lab
          SERVICE_URL=$(gcloud run services describe lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
            --region=${{ env.LABS_GAR_LOCATION }} \
            --format="value(status.url)")

          echo "Service URL: $SERVICE_URL"
          echo "Custom domain: ${{ needs.setup.outputs.domain_prefix }}/${{ matrix.lab }}"

          # Create domain mapping (requires Cloud Run domain mapping API)
          gcloud run domain-mappings create \
            --service=lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
            --domain=${{ matrix.lab }}.${{ needs.setup.outputs.domain_prefix }} \
            --region=${{ env.LABS_GAR_LOCATION }} || true

  deploy-index:
    needs: [setup, deploy-labs, deploy-home-components]
    runs-on: ubuntu-latest
    # Skip deployment for Dependabot PRs (secrets not available)
    # Only deploy if labs components changed or force tag (index is part of labs)
    if: (github.event_name != 'pull_request' || github.actor != 'dependabot[bot]') && needs.setup.outputs.deploy_labs == 'true'
    env:
      HOME_PROJECT_ID: ${{ needs.setup.outputs.home_project_id }}
      LABS_PROJECT_ID: ${{ needs.setup.outputs.labs_project_id }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Authenticate to Google Cloud (Labs Project)
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.LABS_GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Configure Docker to use gcloud as credential helper
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          gcloud auth configure-docker ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev
          # Also configure cross-project access for golden images
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Check if labs index image exists
        id: check-labs-index-image
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          IMAGE="${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:${{ github.sha }}"
          if gcloud artifacts docker images describe "$IMAGE" --project="${{ env.LABS_PROJECT_ID }}" --location="${{ env.LABS_GAR_LOCATION }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image already exists: $IMAGE"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  Image not found, will build: $IMAGE"
          fi

      - name: Build index page container
        if: steps.check-labs-index-image.outputs.exists != 'true'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: deploy/Dockerfile.index
          push: false
          tags: |
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:${{ github.sha }}
            ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:latest
          build-args: |
            ENVIRONMENT=${{ needs.setup.outputs.environment }}
            DOMAIN=${{ needs.setup.outputs.domain_prefix }}
          cache-from: type=gha,scope=index
          cache-to: type=gha,mode=max,scope=index
          load: true

      - name: Push index container to Artifact Registry
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null && steps.check-labs-index-image.outputs.exists != 'true'
        run: |
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:${{ github.sha }}
          docker push ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:latest

      - name: Deploy index page to Cloud Run
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          # For staging: Use --no-allow-unauthenticated (IAM groups will be added via Terraform)
          # For production: Use --allow-unauthenticated (public access)
          if [[ "${{ needs.setup.outputs.environment }}" == "stg" ]]; then
            gcloud run deploy labs-index-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --no-allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},ANALYTICS_SERVICE_URL=https://labs-analytics-${{ needs.setup.outputs.environment }}-hash.a.run.app,SEO_SERVICE_URL=https://labs-seo-${{ needs.setup.outputs.environment }}-hash.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=index,project=e-skimming-labs"
            
            # Grant access to developer groups for staging
            echo "Granting access to developer groups for staging Index service..."
            gcloud run services add-iam-policy-binding labs-index-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:2025-interns@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add 2025-interns group access"
            
            gcloud run services add-iam-policy-binding labs-index-${{ needs.setup.outputs.environment }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --member="group:core-eng@pcioasis.com" \
              --role="roles/run.invoker" || echo "Warning: Failed to add core-eng group access"
          else
            gcloud run deploy labs-index-${{ needs.setup.outputs.environment }} \
              --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/index:${{ github.sha }} \
              --region=${{ env.LABS_GAR_LOCATION }} \
              --platform=managed \
              --allow-unauthenticated \
              --service-account=labs-runtime-sa@${{ env.LABS_PROJECT_ID }}.iam.gserviceaccount.com \
              --port=8080 \
              --memory=512Mi \
              --cpu=1 \
              --min-instances=0 \
              --max-instances=5 \
              --set-env-vars="ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }},ANALYTICS_SERVICE_URL=https://labs-analytics-${{ needs.setup.outputs.environment }}-hash.a.run.app,SEO_SERVICE_URL=https://labs-seo-${{ needs.setup.outputs.environment }}-hash.a.run.app" \
              --labels="environment=${{ needs.setup.outputs.environment }},component=index,project=e-skimming-labs"
          fi

      - name: Configure index domain mapping
        if: env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        run: |
          # Cloud Run domain mapping is limited and doesn't support path-based routing
          # For now, we use direct Cloud Run URLs
          echo "Index service deployed at: https://labs-index-${{ needs.setup.outputs.environment }}-hash.a.run.app"

  notify-deployment:
    needs: [setup, deploy-labs, deploy-home-components, deploy-labs-components]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report deployment status
        run: |
          if [[ "${{ needs.deploy-labs.result }}" == "success" && "${{ needs.deploy-home-components.result }}" == "success" && "${{ needs.deploy-labs-components.result }}" == "success" ]]; then
            echo "‚úÖ All labs deployed successfully to ${{ needs.setup.outputs.domain_prefix }}"
            echo "Labs available at:"
            echo "  - Index: https://${{ needs.setup.outputs.domain_prefix }}"

            # List deployed labs
            labs='${{ needs.setup.outputs.labs }}'
            echo "$labs" | jq -r '.[]' | while read lab; do
              echo "  - $lab: https://${{ needs.setup.outputs.domain_prefix }}/$lab"
            done
          else
            echo "‚ùå Deployment failed"
            echo "deploy-labs result: ${{ needs.deploy-labs.result }}"
            echo "deploy-home-components result: ${{ needs.deploy-home-components.result }}"
            echo "deploy-labs-components result: ${{ needs.deploy-labs-components.result }}"
            exit 1
          fi
         