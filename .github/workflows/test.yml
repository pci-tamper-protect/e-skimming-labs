name: E2E Tests

on:
  pull_request:
    branches: [main, stg]
    paths:
      - 'test/**'
      - 'labs/**'
      - '.github/workflows/test.yml'
  push:
    branches: [main, stg]
    paths:
      - 'test/**'
      - 'labs/**'
      - '.github/workflows/test.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test against'
        required: true
        default: 'stg'
        type: choice
        options:
          - stg
          - prd

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    # Use matrix strategy to shard tests across multiple parallel jobs
    # GitHub Enterprise supports up to 256 matrix jobs
    # Default to 4 shards for optimal performance (can be increased if needed)
    strategy:
      fail-fast: false
      matrix:
        # Create shards: [1, 2, 3, 4] for 4-way parallelization
        shard: [1, 2, 3, 4]
        total-shards: [4]
    env:
      # Use environment-specific secrets for proxy authentication (staging only)
      LABS_GCP_SA_KEY: ${{ secrets.GCP_LABS_SA_KEY_STG || secrets.GCP_LABS_SA_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: test/node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('test/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install dependencies
        working-directory: test
        run: npm ci

      - name: Install Playwright browsers
        working-directory: test
        run: npx playwright install --with-deps chromium

      - name: Determine test environment
        id: test-env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ "${{ github.ref }}" == "refs/heads/stg" ]] || [[ "${{ github.base_ref }}" == "stg" ]]; then
            ENV="stg"
          else
            ENV="prd"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "üß™ Testing against: $ENV environment"

      - name: Authenticate to Google Cloud (for proxy)
        if: steps.test-env.outputs.environment == 'stg' && env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ env.LABS_GCP_SA_KEY }}

      - name: Set up Cloud SDK (for proxy)
        if: steps.test-env.outputs.environment == 'stg' && env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        uses: google-github-actions/setup-gcloud@v3

      - name: Start gcloud proxy for staging tests
        if: steps.test-env.outputs.environment == 'stg' && env.LABS_GCP_SA_KEY != '' && env.LABS_GCP_SA_KEY != null
        id: start-proxy
        run: |
          echo "üîó Starting gcloud proxy for staging tests..."
          PROXY_PORT=8080

          # Start proxy in background
          echo "Starting proxy on port $PROXY_PORT..."
          gcloud run services proxy traefik-stg \
            --region=us-central1 \
            --project=labs-stg \
            --port=$PROXY_PORT > /tmp/proxy.log 2>&1 &

          PROXY_PID=$!
          echo "Proxy PID: $PROXY_PID"
          echo "proxy_pid=$PROXY_PID" >> $GITHUB_OUTPUT
          echo "proxy_port=$PROXY_PORT" >> $GITHUB_OUTPUT

          # Wait for proxy to be ready
          echo "‚è≥ Waiting for proxy to be ready..."
          MAX_WAIT=30
          WAIT_COUNT=0
          while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            # Check if proxy is responding (try both health endpoint and root)
            if curl -sf --max-time 2 http://127.0.0.1:$PROXY_PORT/health > /dev/null 2>&1 || \
               curl -sf --max-time 2 http://127.0.0.1:$PROXY_PORT/ > /dev/null 2>&1; then
              echo "‚úÖ Proxy is ready on port $PROXY_PORT"
              break
            fi
            sleep 1
            WAIT_COUNT=$((WAIT_COUNT + 1))
            if [ $((WAIT_COUNT % 5)) -eq 0 ]; then
              echo "  Still waiting... ($WAIT_COUNT/$MAX_WAIT)"
              # Show proxy log if available
              if [ -f /tmp/proxy.log ]; then
                echo "  Proxy log (last 5 lines):"
                tail -5 /tmp/proxy.log || true
              fi
            fi
          done

          if [ $WAIT_COUNT -eq $MAX_WAIT ]; then
            echo "‚ö†Ô∏è  Warning: Proxy may not be fully ready, but continuing..."
            echo "Proxy log (last 20 lines):"
            tail -20 /tmp/proxy.log || true
            echo ""
            echo "Checking if proxy process is running:"
            ps aux | grep "gcloud run services proxy" | grep -v grep || echo "  No proxy process found"
          fi

          # Verify proxy is actually working before setting URL
          if curl -sf --max-time 5 http://127.0.0.1:$PROXY_PORT/ > /dev/null 2>&1; then
            PROXY_URL="http://127.0.0.1:$PROXY_PORT"
            echo "‚úÖ Proxy confirmed working: $PROXY_URL"
          else
            PROXY_URL=""
            echo "‚ùå Proxy is not responding, tests will use direct URLs"
            echo "Proxy log (last 10 lines):"
            tail -10 /tmp/proxy.log || true
          fi

          echo "proxy_url=$PROXY_URL" >> $GITHUB_OUTPUT
          echo "proxy_pid=$PROXY_PID" >> $GITHUB_OUTPUT

          if [ -n "$PROXY_URL" ]; then
            echo "üîó Proxy URL set: $PROXY_URL"
          else
            echo "‚ö†Ô∏è  Proxy URL not set - tests will use direct domain URLs"
          fi

      - name: Run E2E tests (shard ${{ matrix.shard }}/${{ matrix.total-shards }})
        working-directory: test
        env:
          TEST_ENV: ${{ steps.test-env.outputs.environment }}
          CI: true
          # For staging, use proxy URL if available (set by start-proxy step)
          # Set USE_PROXY based on whether proxy URL is available
          PROXY_URL: ${{ steps.start-proxy.outputs.proxy_url }}
          USE_PROXY: ${{ steps.test-env.outputs.environment == 'stg' && steps.start-proxy.outputs.proxy_url != '' && 'true' || 'false' }}
        run: |
          echo "üß™ Running E2E tests (shard ${{ matrix.shard }}/${{ matrix.total-shards }})"
          echo "TEST_ENV: $TEST_ENV"
          echo "PROXY_URL: $PROXY_URL"
          echo "USE_PROXY: $USE_PROXY"

          if [ "$USE_PROXY" == "true" ] && [ -n "$PROXY_URL" ]; then
            echo "üîó Using gcloud proxy: $PROXY_URL"
          else
            echo "üîó Base URL: https://labs.${{ steps.test-env.outputs.environment == 'stg' && 'stg.' || '' }}pcioasis.com"
          fi

          echo "üìä Test shard: ${{ matrix.shard }}/${{ matrix.total-shards }}"
          npx playwright test e2e --shard=${{ matrix.shard }}/${{ matrix.total-shards }}
        continue-on-error: true

      - name: Stop proxy (cleanup)
        if: always() && steps.test-env.outputs.environment == 'stg' && steps.start-proxy.outputs.proxy_pid != ''
        run: |
          echo "üßπ Stopping proxy..."
          PROXY_PID="${{ steps.start-proxy.outputs.proxy_pid }}"
          if [ -n "$PROXY_PID" ] && kill -0 "$PROXY_PID" 2>/dev/null; then
            kill "$PROXY_PID" 2>/dev/null || true
            echo "‚úÖ Proxy stopped"
          else
            # Try to kill any remaining proxy processes
            pkill -f "gcloud run services proxy" || true
            echo "‚úÖ Cleaned up proxy processes"
          fi

      - name: Upload test results (shard ${{ matrix.shard }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ steps.test-env.outputs.environment }}-shard-${{ matrix.shard }}
          path: test/playwright-report/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test JSON results (shard ${{ matrix.shard }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-json-${{ steps.test-env.outputs.environment }}-shard-${{ matrix.shard }}
          path: test/test-results/results.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test screenshots (shard ${{ matrix.shard }})
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-screenshots-${{ steps.test-env.outputs.environment }}-shard-${{ matrix.shard }}
          path: test/test-results/
          retention-days: 7
          if-no-files-found: ignore

  e2e-tests-summary:
    needs: e2e-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all test results
        if: always()
        uses: actions/download-artifact@v4
        with:
          pattern: playwright-json-*-shard-*
          merge-multiple: true
          path: test/test-results-merged/
          if-no-files-found: ignore

      - name: Check which shard jobs failed using GitHub API
        id: check-shard-jobs
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking which test shard jobs failed..."
          FAILED_SHARDS=()

          # Use GitHub CLI to check workflow run jobs
          if command -v gh &> /dev/null && gh auth status &> /dev/null; then
            echo "Using GitHub CLI to check job status..."
            # Get jobs for this workflow run
            JOBS=$(gh run view ${{ github.run_id }} --json jobs --jq '.jobs[] | select(.name | startswith("e2e-tests")) | {name: .name, conclusion: .conclusion, status: .status}')
            echo "$JOBS" | jq -r '.name + ": " + .conclusion + " (" + .status + ")"' || echo "Could not parse job results"

            # Extract shard numbers from failed jobs
            echo "$JOBS" | jq -r 'select(.conclusion == "failure" or .conclusion == "cancelled") | .name' | while read job_name; do
              if [[ "$job_name" =~ shard[[:space:]]*([0-9]+) ]]; then
                shard_num="${BASH_REMATCH[1]}"
                FAILED_SHARDS+=("$shard_num")
                echo "Found failed shard: $shard_num"
              fi
            done
          else
            echo "GitHub CLI not available, will infer from test results"
          fi

          # Output failed shards
          if [ ${#FAILED_SHARDS[@]} -gt 0 ]; then
            echo "failed_shards=${FAILED_SHARDS[*]}" >> $GITHUB_OUTPUT
            echo "has_failed_shards=true" >> $GITHUB_OUTPUT
          else
            echo "has_failed_shards=false" >> $GITHUB_OUTPUT
          fi

      - name: Analyze test results and identify failed shards
        id: analyze-results
        if: always()
        run: |
          echo "üìä Analyzing test results from all shards..."

          TOTAL_TESTS=0
          FAILED_TESTS=0
          PASSED_TESTS=0

          # Check JSON results files if they exist
          if [ -d "test/test-results-merged" ]; then
            for json_file in test/test-results-merged/*.json; do
              if [ -f "$json_file" ]; then
                echo "Found results file: $json_file"
                if command -v jq &> /dev/null; then
                  stats=$(jq -r '.stats // {}' "$json_file" 2>/dev/null || echo "{}")
                  if [ -n "$stats" ] && [ "$stats" != "{}" ]; then
                    failures=$(echo "$stats" | jq -r '.failures // 0' 2>/dev/null || echo "0")
                    total=$(echo "$stats" | jq -r '.total // 0' 2>/dev/null || echo "0")
                    passed=$(echo "$stats" | jq -r '.passed // 0' 2>/dev/null || echo "0")
                    FAILED_TESTS=$((FAILED_TESTS + failures))
                    TOTAL_TESTS=$((TOTAL_TESTS + total))
                    PASSED_TESTS=$((PASSED_TESTS + passed))
                    echo "  Failures: $failures, Passed: $passed, Total: $total"
                  fi
                fi
              fi
            done
          fi

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT

          if [ "$FAILED_TESTS" -gt 0 ] || [ "${{ steps.check-shard-jobs.outputs.has_failed_shards }}" == "true" ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
            echo "‚ùå Test failures detected: $FAILED_TESTS out of $TOTAL_TESTS tests failed"
            if [ "${{ steps.check-shard-jobs.outputs.failed_shards }}" != "" ]; then
              echo "Failed shards: ${{ steps.check-shard-jobs.outputs.failed_shards }}"
            fi
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
            if [ "$TOTAL_TESTS" -gt 0 ]; then
              echo "‚úÖ All tests passed: $TOTAL_TESTS tests"
            else
              echo "‚ö†Ô∏è  No test results found (tests may have failed before producing results)"
              echo "has_failures=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Generate test summary
        if: always()
        run: |
          echo "## üß™ E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Shards:** 4" >> $GITHUB_STEP_SUMMARY
          echo "**Total Tests:** ${{ steps.analyze-results.outputs.total_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "**Passed Tests:** ${{ steps.analyze-results.outputs.passed_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "**Failed Tests:** ${{ steps.analyze-results.outputs.failed_tests }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.analyze-results.outputs.has_failures }}" == "true" ]; then
            echo "‚ùå **Some test shards failed**" >> $GITHUB_STEP_SUMMARY
            if [ -n "${{ steps.check-shard-jobs.outputs.failed_shards }}" ]; then
              echo "**Failed Shards:** ${{ steps.check-shard-jobs.outputs.failed_shards }}" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check individual shard jobs in the workflow run for detailed failure information:" >> $GITHUB_STEP_SUMMARY
            echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **All tests passed**" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- HTML Reports: playwright-report-*-shard-*" >> $GITHUB_STEP_SUMMARY
          echo "- JSON Results: playwright-json-*-shard-*" >> $GITHUB_STEP_SUMMARY
          echo "- Screenshots: playwright-screenshots-*-shard-*" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any shard had test failures
        if: steps.analyze-results.outputs.has_failures == 'true'
        run: |
          echo "‚ùå Test failures detected. Failing summary step."
          echo ""
          echo "Test Summary:"
          echo "  - Total Tests: ${{ steps.analyze-results.outputs.total_tests }}"
          echo "  - Passed Tests: ${{ steps.analyze-results.outputs.passed_tests }}"
          echo "  - Failed Tests: ${{ steps.analyze-results.outputs.failed_tests }}"
          if [ -n "${{ steps.check-shard-jobs.outputs.failed_shards }}" ]; then
            echo "  - Failed Shards: ${{ steps.check-shard-jobs.outputs.failed_shards }}"
          fi
          echo ""
          echo "Check individual shard jobs in the workflow run to see detailed failure information:"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          exit 1
