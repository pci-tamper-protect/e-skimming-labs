name: Auto Copilot Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

# GitHub Copilot PR reviews are automatic when enabled
# This workflow ensures Copilot reviews are triggered on all PR updates
# 
# To enable Copilot reviews:
# 1. Repository Settings ‚Üí General ‚Üí Features ‚Üí Copilot ‚Üí Pull request reviews
#    Or: https://github.com/pci-tamper-protect/e-skimming-labs/settings/copilot
# 2. Organization level (recommended): 
#    https://github.com/organizations/pci-tamper-protect/settings/copilot
#
# Once enabled, Copilot will automatically review:
# - All PRs (including auto-generated PRs)
# - Feature branch PRs ‚Üí stg
# - Stg ‚Üí main PRs
# - Fresh reviews on every PR update

jobs:
  ensure-copilot-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
      - name: Request Copilot Review
        uses: actions/github-script@v8
        with:
          script: |
            // GitHub Copilot reviews are automatic when enabled
            // This workflow ensures PRs are ready and triggers Copilot review
            
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const baseBranch = context.payload.pull_request.base.ref;
            const headBranch = context.payload.pull_request.head.ref;
            const isDraft = context.payload.pull_request.draft;
            
            console.log(`üìã PR #${prNumber}: ${headBranch} ‚Üí ${baseBranch}`);
            
            if (isDraft) {
              console.log(`‚ÑπÔ∏è  PR is in draft mode - Copilot will review when marked as ready`);
            } else {
              console.log(`‚úÖ PR is ready for review`);
              
              // Try to trigger Copilot review by updating PR (triggers review if enabled)
              // Note: Copilot reviews are automatic when enabled in settings
              // This step ensures the PR is in a state where Copilot can review it
              try {
                // Check if Copilot is enabled by checking PR reviews
                const reviews = await github.rest.pulls.listReviews({
                  owner: owner,
                  repo: repo,
                  pull_number: prNumber,
                });
                
                const copilotReview = reviews.data.find(r => 
                  r.user?.login?.includes('copilot') || 
                  r.user?.login?.includes('github-actions')
                );
                
                if (copilotReview) {
                  console.log(`‚úÖ Copilot has already reviewed this PR`);
                } else {
                  console.log(`‚ÑπÔ∏è  Waiting for Copilot review (automatic when enabled)`);
                  console.log(`   Enable at: https://github.com/${owner}/${repo}/settings/copilot`);
                }
              } catch (error) {
                console.log(`‚ÑπÔ∏è  Copilot reviews are automatic when enabled in repository settings`);
                console.log(`   Enable at: https://github.com/${owner}/${repo}/settings/copilot`);
              }
            }

