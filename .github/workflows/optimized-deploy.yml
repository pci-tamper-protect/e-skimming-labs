name: Optimized Deploy E-Skimming Labs to Cloud Run

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'prd'
        type: choice
        options:
          - prd
          - stg

env:
  # Home page project (labs-home-prd)
  HOME_PROJECT_ID: ${{ secrets.GCP_HOME_PROJECT_ID }}
  HOME_GAR_LOCATION: ${{ secrets.GAR_HOME_LOCATION }}
  HOME_REPOSITORY: ${{ secrets.REPOSITORY_HOME }}
  HOME_GCP_SA_KEY: ${{ secrets.GCP_HOME_SA_KEY }}

  # Individual labs project (labs-prd)
  LABS_PROJECT_ID: ${{ secrets.GCP_LABS_PROJECT_ID }}
  LABS_GAR_LOCATION: ${{ secrets.GAR_LABS_LOCATION }}
  LABS_REPOSITORY: ${{ secrets.REPOSITORY_LABS }}
  LABS_GCP_SA_KEY: ${{ secrets.GCP_LABS_SA_KEY }}

  # Golden base images
  GOLDEN_REGISTRY: us-central1-docker.pkg.dev/pcioasis-ops/containers
  GO_BASE_IMAGE: ${{ env.GOLDEN_REGISTRY }}/go-base:1.24.3-alpine
  NGINX_BASE_IMAGE: ${{ env.GOLDEN_REGISTRY }}/nginx-base:1.25-alpine

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      labs: ${{ steps.discover-labs.outputs.labs }}
      environment: ${{ steps.set-env.outputs.environment }}
      domain_prefix: ${{ steps.set-env.outputs.domain_prefix }}
      changed-services: ${{ steps.detect-changes.outputs.changed-services }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for change detection

      - name: Set environment variables
        id: set-env
        run: |
          if [[ "${{ github.event.inputs.environment }}" == "stg" ]]; then
            echo "environment=stg" >> $GITHUB_OUTPUT
            echo "domain_prefix=labs.stg.pcioasis.com" >> $GITHUB_OUTPUT
          else
            echo "environment=prd" >> $GITHUB_OUTPUT
            echo "domain_prefix=labs.pcioasis.com" >> $GITHUB_OUTPUT
          fi

      - name: Discover lab directories
        id: discover-labs
        run: |
          labs=$(find ./labs -maxdepth 1 -type d -name "*-*" | sed 's|./labs/||' | sort | jq -R -s -c 'split("\n")[:-1]')
          echo "labs=$labs" >> $GITHUB_OUTPUT
          echo "Discovered labs: $labs"

      - name: Detect changed services
        id: detect-changes
        run: |
          # Detect which services have changed
          changed_files=$(git diff --name-only HEAD~1 HEAD || echo "")
          changed_services="[]"

          if echo "$changed_files" | grep -q "deploy/shared-components/home-index-service/"; then
            changed_services=$(echo "$changed_services" | jq '. + ["home-index"]')
          fi
          if echo "$changed_files" | grep -q "deploy/shared-components/seo-service/"; then
            changed_services=$(echo "$changed_services" | jq '. + ["seo"]')
          fi
          if echo "$changed_files" | grep -q "deploy/shared-components/analytics-service/"; then
            changed_services=$(echo "$changed_services" | jq '. + ["analytics"]')
          fi

          echo "changed-services=$changed_services" >> $GITHUB_OUTPUT
          echo "Changed services: $changed_services"

  # Build golden base images (run weekly or when base dependencies change)
  build-golden-images:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || contains(github.event.head_commit.message, '[build-golden]')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Ops Project)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_OPS_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as credential helper
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: Build Go base image
        run: |
          docker build \
            -t ${{ env.GO_BASE_IMAGE }} \
            -f .github/dockerfiles/go-base.Dockerfile \
            .

      - name: Build Nginx base image
        run: |
          docker build \
            -t ${{ env.NGINX_BASE_IMAGE }} \
            -f .github/dockerfiles/nginx-base.Dockerfile \
            .

      - name: Push golden base images
        run: |
          docker push ${{ env.GO_BASE_IMAGE }}
          docker push ${{ env.NGINX_BASE_IMAGE }}

  # Parallel deployment of home and labs components
  deploy-components:
    needs: [setup, build-golden-images]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [home-index, seo, analytics]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{
            matrix.component == 'home-index' || matrix.component == 'seo'
            ? env.HOME_GCP_SA_KEY
            : env.LABS_GCP_SA_KEY
          }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as credential helper
        run: |
          gcloud auth configure-docker ${{
            matrix.component == 'home-index' || matrix.component == 'seo'
            ? env.HOME_GAR_LOCATION
            : env.LABS_GAR_LOCATION
          }}-docker.pkg.dev

      - name: Build component with cache
        run: |
          # Use golden base image and build with cache
          docker buildx build \
            --platform linux/amd64 \
            --cache-from type=registry,ref=${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }}-docker.pkg.dev/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_PROJECT_ID
            }}/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_REPOSITORY
              : env.LABS_REPOSITORY
            }}/${{ matrix.component }}:cache \
            --cache-to type=registry,ref=${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }}-docker.pkg.dev/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_REPOSITORY
            }}/${{ matrix.component }}:cache,mode=max \
            --build-arg ENVIRONMENT=${{ needs.setup.outputs.environment }} \
            --build-arg BASE_IMAGE=${{ env.GO_BASE_IMAGE }} \
            -t ${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }}-docker.pkg.dev/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_PROJECT_ID
            }}/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_REPOSITORY
              : env.LABS_REPOSITORY
            }}/${{ matrix.component }}:${{ github.sha }} \
            -t ${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }}-docker.pkg.dev/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_PROJECT_ID
            }}/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_REPOSITORY
              : env.LABS_REPOSITORY
            }}/${{ matrix.component }}:latest \
            -f deploy/shared-components/${{ matrix.component }}-service/Dockerfile \
            --push \
            .

      - name: Deploy to Cloud Run
        run: |
          # Deploy component to Cloud Run
          gcloud run deploy ${{ matrix.component }}-${{ needs.setup.outputs.environment }} \
            --image=${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }}-docker.pkg.dev/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_PROJECT_ID
            }}/${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_REPOSITORY
              : env.LABS_REPOSITORY
            }}/${{ matrix.component }}:${{ github.sha }} \
            --region=${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_GAR_LOCATION
              : env.LABS_GAR_LOCATION
            }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="PROJECT_ID=${{
              matrix.component == 'home-index' || matrix.component == 'seo'
              ? env.HOME_PROJECT_ID
              : env.LABS_PROJECT_ID
            }},ENVIRONMENT=${{ needs.setup.outputs.environment }}" \
            --labels="environment=${{ needs.setup.outputs.environment }},component=${{ matrix.component }},project=e-skimming-labs"

  deploy-labs:
    needs: [setup, deploy-components]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        lab: ${{ fromJson(needs.setup.outputs.labs) }}
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud (Labs Project)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ env.LABS_GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker to use gcloud as credential helper
        run: |
          gcloud auth configure-docker ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev

      - name: Build lab with nginx base image
        run: |
          docker buildx build \
            --platform linux/amd64 \
            --cache-from type=registry,ref=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:cache \
            --cache-to type=registry,ref=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:cache,mode=max \
            --build-arg BASE_IMAGE=${{ env.NGINX_BASE_IMAGE }} \
            --build-arg LAB_NAME=${{ matrix.lab }} \
            --build-arg ENVIRONMENT=${{ needs.setup.outputs.environment }} \
            -t ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }} \
            -t ${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:latest \
            -f labs/${{ matrix.lab }}/Dockerfile \
            --push \
            labs/${{ matrix.lab }}/

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy lab-${{ matrix.lab }}-${{ needs.setup.outputs.environment }} \
            --image=${{ env.LABS_GAR_LOCATION }}-docker.pkg.dev/${{ env.LABS_PROJECT_ID }}/${{ env.LABS_REPOSITORY }}/${{ matrix.lab }}:${{ github.sha }} \
            --region=${{ env.LABS_GAR_LOCATION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="LAB_NAME=${{ matrix.lab }},ENVIRONMENT=${{ needs.setup.outputs.environment }},DOMAIN=${{ needs.setup.outputs.domain_prefix }}" \
            --labels="environment=${{ needs.setup.outputs.environment }},lab=${{ matrix.lab }},project=e-skimming-labs"

  notify-deployment:
    needs: [setup, deploy-components, deploy-labs]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report deployment status
        run: |
          if [[ "${{ needs.deploy-components.result }}" == "success" && "${{ needs.deploy-labs.result }}" == "success" ]]; then
            echo "✅ All labs deployed successfully to ${{ needs.setup.outputs.domain_prefix }}"
            echo "Labs available at:"
            echo "  - Index: https://${{ needs.setup.outputs.domain_prefix }}"

            # List deployed labs
            labs='${{ needs.setup.outputs.labs }}'
            echo "$labs" | jq -r '.[]' | while read lab; do
              echo "  - $lab: https://${{ needs.setup.outputs.domain_prefix }}/$lab"
            done
          else
            echo "❌ Deployment failed"
            echo "deploy-components result: ${{ needs.deploy-components.result }}"
            echo "deploy-labs result: ${{ needs.deploy-labs.result }}"
            exit 1
          fi

