<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C2 Server Dashboard - Lab 1 Basic Magecart</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: #ffffff;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        padding: 1rem 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        margin-top: 0.25rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .stat-card h3 {
        color: #fbbf24;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #dc2626;
      }

      .data-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .data-section h2 {
        color: #fbbf24;
        margin-bottom: 1rem;
        font-size: 1.25rem;
      }

      .stolen-record {
        background: rgba(220, 38, 38, 0.1);
        border: 1px solid rgba(220, 38, 38, 0.3);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .stolen-record h4 {
        color: #fca5a5;
        margin-bottom: 0.5rem;
      }

      .stolen-record pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        overflow-x: auto;
        color: #e5e7eb;
      }

      .no-data {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
        font-style: italic;
      }

      .refresh-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .refresh-btn:hover {
        background: #b91c1c;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        color: #fbbf24;
      }

      .nav-buttons-row {
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-buttons-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-button {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
        font-size: 0.875rem;
      }

      .nav-button.back-button {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .nav-button.back-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-button.home-button {
        background: #dc2626;
        color: #ffffff;
        border: 1px solid #991b1b;
      }

      .nav-button.home-button:hover {
        background: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üïµÔ∏è C2 Server Dashboard - Lab 1 Basic Magecart</h1>
      <p><span class="status-indicator"></span>Command & Control Server Active</p>
    </div>

    <!-- Navigation Buttons Row -->
    <div class="nav-buttons-row">
      <div class="nav-buttons-container">
        <a href="#" class="nav-button back-button" id="back-button">‚Üê Back to Lab</a>
        <a href="#" class="nav-button home-button" id="home-button">üè† Home</a>
      </div>
    </div>

    <div class="container">
      <div class="warning">
        <strong>‚ö†Ô∏è EDUCATIONAL PURPOSE ONLY:</strong> This dashboard simulates a real attacker's C2
        server interface. All data shown is for educational purposes in a controlled lab
        environment.
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Records</h3>
          <div class="stat-value" id="totalRecords">0</div>
        </div>
        <div class="stat-card">
          <h3>Server Status</h3>
          <div class="stat-value" style="font-size: 1rem; color: #10b981">Operational</div>
        </div>
        <div class="stat-card">
          <h3>Last Activity</h3>
          <div class="stat-value" id="lastActivity" style="font-size: 1rem">Never</div>
        </div>
      </div>

      <div class="data-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
          "
        >
          <h2>Stolen Credit Card Data</h2>
          <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
        </div>
        <div id="stolenData">
          <div class="no-data">
            No stolen data yet. Trigger the attack in Lab 1 to see data appear here.
          </div>
        </div>
      </div>
    </div>

    <script>
      async function loadData() {
        try {
          // Load statistics with retry
          let stats
          try {
            const statsResponse = await fetch('/stats')
            if (!statsResponse.ok) throw new Error('Stats fetch failed')
            stats = await statsResponse.json()
            document.getElementById('totalRecords').textContent = stats.totalRecords || 0
          } catch (error) {
            console.warn('Stats fetch failed, using default:', error)
            document.getElementById('totalRecords').textContent = 'N/A'
          }

          // Load stolen data with retry
          let stolenData
          try {
            const stolenResponse = await fetch('/api/stolen')
            if (!stolenResponse.ok) throw new Error('Stolen data fetch failed')
            stolenData = await stolenResponse.json()
          } catch (error) {
            console.error('Failed to load stolen data:', error)
            throw error
          }

          const container = document.getElementById('stolenData')

          if (stolenData.length === 0) {
            container.innerHTML =
              '<div class="no-data">No stolen data yet. Trigger the attack in Lab 1 to see data appear here.</div>'
          } else {
            container.innerHTML = stolenData
              .map((record, index) => {
                // Extract credit card info for display
                let cardInfo = ''
                if (record.cardNumber) {
                  const card = record.cardNumber.replace(/\s/g, '')
                  if (card.length >= 8) {
                    const first4 = card.substring(0, 4)
                    const last4 = card.substring(card.length - 4)
                    const masked = '*'.repeat(card.length - 8)
                    cardInfo = `${first4}${masked}${last4}`
                  }
                }

                return `
                            <div class="stolen-record">
                                <h4>Record #${index + 1} - ${record.timestamp || 'Unknown time'}</h4>
                                <div style="margin-bottom: 1rem;">
                                    ${cardInfo ? `<strong>üí≥ Card:</strong> ${cardInfo}<br>` : ''}
                                    ${record.cardholderName ? `<strong>üë§ Name:</strong> ${record.cardholderName}<br>` : ''}
                                    ${record.email ? `<strong>üìß Email:</strong> ${record.email}<br>` : ''}
                                    ${record.expiryMonth && record.expiryYear ? `<strong>üìÖ Expires:</strong> ${record.expiryMonth}/${record.expiryYear}<br>` : ''}
                                    ${record.cvv ? `<strong>üîê CVV:</strong> ${record.cvv}<br>` : ''}
                                </div>
                                <details>
                                    <summary style="cursor: pointer; color: #fbbf24;">View Full Data</summary>
                                    <pre style="margin-top: 0.5rem;">${JSON.stringify(record, null, 2)}</pre>
                                </details>
                            </div>
                        `
              })
              .join('')

            // Update last activity
            const lastRecord = stolenData[0]
            if (lastRecord && lastRecord.timestamp) {
              document.getElementById('lastActivity').textContent = new Date(
                lastRecord.timestamp
              ).toLocaleString()
            }
          }
        } catch (error) {
          console.error('Failed to load data:', error)
          document.getElementById('stolenData').innerHTML =
            '<div class="no-data">Error loading data. Make sure the C2 server is running.</div>'
        }
      }

      // Load data on page load
      loadData()

      // Auto-refresh every 5 seconds
      setInterval(loadData, 5000)

      // Environment-aware URL configuration
      ;(function () {
        const hostname = window.location.hostname
        let labUrl = 'http://localhost:9001'
        let homeUrl = 'http://localhost:3000'

        // Check if we're in staging
        if (hostname.includes('stg.pcioasis.com') || hostname.includes('staging')) {
          labUrl = 'https://labs.stg.pcioasis.com/01-basic-magecart'
          homeUrl = 'https://labs.stg.pcioasis.com'
        }
        // Check if we're in production
        else if (hostname.includes('pcioasis.com') && !hostname.includes('stg')) {
          labUrl = 'https://labs.pcioasis.com/01-basic-magecart'
          homeUrl = 'https://labs.pcioasis.com'
        }
        // Check if we're in Cloud Run
        else if (hostname.includes('run.app')) {
          const baseUrl = window.location.origin
          // Lab 1 has both vulnerable site and C2 in same container
          // C2 is accessible at /stolen, lab is at root
          labUrl = baseUrl.replace('/stolen', '').replace('/api/stolen', '')
          homeUrl = baseUrl.replace('/01-basic-magecart-c2', '').replace('/stolen', '').replace('/api/stolen', '')
          // Try to extract home URL from hostname
          if (hostname.includes('lab-01-basic-magecart')) {
            homeUrl = 'https://labs.pcioasis.com'
          }
        }

        const backButton = document.getElementById('back-button')
        const homeButton = document.getElementById('home-button')

        if (backButton) {
          backButton.href = labUrl
        }
        if (homeButton) {
          homeButton.href = homeUrl
        }
      })()
    </script>
  </body>
</html>
