<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>C2 Server Dashboard - Lab 2 DOM Skimming</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
        color: #ffffff;
        min-height: 100vh;
      }

      .header {
        background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
        padding: 1rem 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 700;
      }

      .header p {
        opacity: 0.9;
        margin-top: 0.25rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
      }

      .stat-card h3 {
        color: #fbbf24;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
      }

      .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #dc2626;
      }

      .stat-value.small {
        font-size: 1.25rem;
      }

      .data-section {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .data-section h2 {
        color: #fbbf24;
        margin-bottom: 1rem;
        font-size: 1.25rem;
      }

      .attack-record {
        background: rgba(220, 38, 38, 0.1);
        border: 1px solid rgba(220, 38, 38, 0.3);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .attack-record h4 {
        color: #fca5a5;
        margin-bottom: 0.5rem;
      }

      .attack-record pre {
        background: rgba(0, 0, 0, 0.3);
        padding: 0.75rem;
        border-radius: 4px;
        font-size: 0.875rem;
        overflow-x: auto;
        color: #e5e7eb;
      }

      .no-data {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
        font-style: italic;
      }

      .refresh-btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .refresh-btn:hover {
        background: #b91c1c;
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #10b981;
        margin-right: 0.5rem;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .warning {
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 6px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        color: #fbbf24;
      }

      .tabs {
        display: flex;
        margin-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .tab {
        background: none;
        border: none;
        color: #9ca3af;
        padding: 0.75rem 1.5rem;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
      }

      .tab.active {
        color: #fbbf24;
        border-bottom-color: #fbbf24;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .nav-buttons-row {
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }

      .nav-buttons-container {
        max-width: 1200px;
        margin: 0 auto;
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-button {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s;
        font-size: 0.875rem;
      }

      .nav-button.back-button {
        background: rgba(255, 255, 255, 0.1);
        color: #ffffff;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .nav-button.back-button:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .nav-button.home-button {
        background: #dc2626;
        color: #ffffff;
        border: 1px solid #991b1b;
      }

      .nav-button.home-button:hover {
        background: #b91c1c;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1>üïµÔ∏è C2 Server Dashboard - Lab 2 DOM Skimming</h1>
      <p><span class="status-indicator"></span>Command & Control Server Active</p>
    </div>

    <!-- Navigation Buttons Row -->
    <div class="nav-buttons-row">
      <div class="nav-buttons-container">
        <a href="#" class="nav-button back-button" id="back-button" aria-label="Back Button">‚Üê Back to Lab</a>
        <a href="#" class="nav-button home-button" id="home-button" aria-label="Home Button">üè† Home</a>
      </div>
    </div>

    <div class="container">
      <div class="warning">
        <strong>‚ö†Ô∏è EDUCATIONAL PURPOSE ONLY:</strong> This dashboard simulates a real attacker's C2
        server interface. All data shown is for educational purposes in a controlled lab
        environment.
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total Attacks</h3>
          <div class="stat-value" id="totalAttacks">0</div>
        </div>
        <div class="stat-card">
          <h3>Unique Victims</h3>
          <div class="stat-value" id="uniqueVictims">0</div>
        </div>
        <div class="stat-card">
          <h3>Uptime</h3>
          <div class="stat-value small" id="uptime">0h 0m</div>
        </div>
        <div class="stat-card">
          <h3>Server Status</h3>
          <div class="stat-value small" style="color: #10b981">Healthy</div>
        </div>
      </div>

      <div class="data-section">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
          "
        >
          <h2>Attack Data</h2>
          <button class="refresh-btn" onclick="loadData()" aria-label="Refresh Button">üîÑ Refresh</button>
        </div>

        <div class="tabs">
          <button class="tab active" onclick="switchTab('recent')" aria-label="Tab Active">Recent Attacks</button>
          <button class="tab" onclick="switchTab('stats')" aria-label="Switch Tab">Statistics</button>
        </div>

        <div id="recent-tab" class="tab-content active">
          <div id="recentData">
            <div class="no-data">
              No attack data yet. Trigger the attack in Lab 2 to see data appear here.
            </div>
          </div>
        </div>

        <div id="stats-tab" class="tab-content">
          <div id="statsData">
            <div class="no-data">Loading statistics...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Helper function to extract credit card data from fieldData structure
      function extractCardData(records) {
        // Group records by session/timestamp to form complete credit card records
        const groupedRecords = new Map()

        records.forEach(record => {
          if (record.fieldData && record.fieldData.values && record.fieldData.values.length > 0) {
            // Get the latest value from the field
            const latestValue = record.fieldData.values[record.fieldData.values.length - 1].value
            const fieldName = record.fieldData.fieldName || ''
            const timestamp = record.serverTimestamp || record.timestamp

            // Group by timestamp (within 5 seconds) and metadata URL
            const sessionKey = `${record.metadata?.url || ''}_${Math.floor(timestamp / 5000)}`

            if (!groupedRecords.has(sessionKey)) {
              groupedRecords.set(sessionKey, {
                timestamp: timestamp,
                metadata: record.metadata || {},
                fields: {}
              })
            }

            const session = groupedRecords.get(sessionKey)

            // Map field names to credit card data structure
            if (fieldName.includes('card') && (fieldName.includes('number') || fieldName.includes('Number'))) {
              session.fields.cardNumber = latestValue
            } else if (fieldName.includes('cvv') || fieldName.includes('Cvv') || fieldName.includes('CVV')) {
              session.fields.cvv = latestValue
            } else if (fieldName.includes('exp') || fieldName.includes('Exp') || fieldName.includes('expiry')) {
              session.fields.expiry = latestValue
            } else if (fieldName.includes('holder') || fieldName.includes('Holder') || fieldName.includes('name')) {
              session.fields.cardholderName = latestValue
            } else if (fieldName.includes('zip') || fieldName.includes('Zip')) {
              session.fields.billingZip = latestValue
            }
          }
        })

        // Convert to array and sort by timestamp
        return Array.from(groupedRecords.values())
          .map(session => ({
            cardNumber: session.fields.cardNumber,
            cvv: session.fields.cvv,
            expiry: session.fields.expiry,
            cardholderName: session.fields.cardholderName,
            billingZip: session.fields.billingZip,
            timestamp: session.timestamp,
            metadata: session.metadata
          }))
          .filter(record => record.cardNumber || record.cvv || record.expiry) // Only show records with card data
          .sort((a, b) => b.timestamp - a.timestamp)
      }

      async function loadData() {
        try {
          // Load statistics
          const statsResponse = await fetch('/stats')
          const stats = await statsResponse.json()

          document.getElementById('totalAttacks').textContent = stats.totalRequests || 0
          document.getElementById('uniqueVictims').textContent = stats.uniqueVictims || 0

          if (stats.uptimeHours) {
            const hours = Math.floor(stats.uptimeHours)
            const minutes = Math.floor((stats.uptimeHours - hours) * 60)
            document.getElementById('uptime').textContent = `${hours}h ${minutes}m`
          }

          // Load all stolen data (like Lab 1)
          const stolenResponse = await fetch('/api/stolen')
          const allData = await stolenResponse.json()

          const recentContainer = document.getElementById('recentData')

          if (allData.length === 0) {
            recentContainer.innerHTML =
              '<div class="no-data">No attack data yet. Trigger the attack in Lab 2 to see data appear here.</div>'
          } else {
            // Extract and group credit card data
            const cardRecords = extractCardData(allData)

            if (cardRecords.length === 0) {
              recentContainer.innerHTML =
                '<div class="no-data">No credit card data found. Data may still be collecting...</div>'
            } else {
              recentContainer.innerHTML = cardRecords
                .map((record, index) => {
                  // Extract credit card info for display
                  let cardInfo = ''
                  if (record.cardNumber) {
                    const card = record.cardNumber.replace(/\s/g, '')
                    if (card.length >= 8) {
                      const first4 = card.substring(0, 4)
                      const last4 = card.substring(card.length - 4)
                      const masked = '*'.repeat(card.length - 8)
                      cardInfo = `${first4}${masked}${last4}`
                    } else {
                      cardInfo = card
                    }
                  }

                  const displayTime = record.timestamp
                    ? new Date(record.timestamp).toLocaleString()
                    : 'Unknown time'

                  return `
                    <div class="attack-record">
                      <h4>Record #${index + 1} - ${displayTime}</h4>
                      <div style="margin-bottom: 1rem;">
                        ${cardInfo ? `<strong>üí≥ Card:</strong> ${cardInfo}<br>` : ''}
                        ${record.cardholderName ? `<strong>üë§ Name:</strong> ${record.cardholderName}<br>` : ''}
                        ${record.expiry ? `<strong>üìÖ Expires:</strong> ${record.expiry}<br>` : ''}
                        ${record.cvv ? `<strong>üîê CVV:</strong> ${record.cvv}<br>` : ''}
                        ${record.billingZip ? `<strong>üìç ZIP:</strong> ${record.billingZip}<br>` : ''}
                        ${record.metadata?.url ? `<strong>üåê URL:</strong> ${record.metadata.url}<br>` : ''}
                      </div>
                      <details>
                        <summary style="cursor: pointer; color: #fbbf24;">View Full Data</summary>
                        <pre style="margin-top: 0.5rem;">${JSON.stringify(record, null, 2)}</pre>
                      </details>
                    </div>
                  `
                })
                .join('')
            }
          }

          // Update stats tab
          document.getElementById('statsData').innerHTML = `
            <div class="stat-card">
              <h3>Attack Statistics</h3>
              <pre>${JSON.stringify(stats, null, 2)}</pre>
            </div>
          `
        } catch (error) {
          console.error('Failed to load data:', error)
          document.getElementById('recentData').innerHTML =
            '<div class="no-data">Error loading data. Make sure the C2 server is running.</div>'
        }
      }

      function switchTab(tabName) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'))
        document
          .querySelectorAll('.tab-content')
          .forEach(content => content.classList.remove('active'))

        // Add active class to selected tab and content
        event.target.classList.add('active')
        document.getElementById(tabName + '-tab').classList.add('active')
      }

      // Load data on page load
      loadData()

      // Auto-refresh every 5 seconds
      setInterval(loadData, 5000)

      // Environment-aware URL configuration with uniform path-based routing
      ;(function () {
        const hostname = window.location.hostname

        // Determine base URL based on environment
        let baseUrl
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
          // Local development - use port 8080 (Traefik)
          baseUrl = 'http://localhost:8080'
        } else if (hostname.includes('stg.pcioasis.com') || hostname.includes('staging')) {
          // Staging environment
          baseUrl = 'https://labs.stg.pcioasis.com'
        } else if (hostname.includes('pcioasis.com') && !hostname.includes('stg')) {
          // Production environment
          baseUrl = 'https://labs.pcioasis.com'
        } else {
          // Fallback: use current origin
          baseUrl = window.location.origin
        }

        // Uniform path-based routing (works across all environments)
        const labUrl = baseUrl + '/lab2'
        const homeUrl = baseUrl + '/'

        const backButton = document.getElementById('back-button')
        const homeButton = document.getElementById('home-button')

        if (backButton) {
          backButton.href = labUrl
        }
        if (homeButton) {
          homeButton.href = homeUrl
        }
      })()
    </script>
  </body>
</html>
