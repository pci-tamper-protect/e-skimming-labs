<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>SecureBank Online Banking</title>
    <link rel="stylesheet" href="css/banking.css" id="main-css" />
    <script>
      // Cache busting for development - inject before page loads
      (function() {
        const hostname = window.location.hostname
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1'
        if (isLocal) {
          const timestamp = Date.now()
          const cssLink = document.getElementById('main-css')
          if (cssLink && !cssLink.href.includes('?')) {
            cssLink.href = cssLink.href + '?v=' + timestamp
          }
        }
      })()
    </script>
  </head>
  <body>
    <header class="bank-header">
      <div class="container">
        <div class="logo">
          <h1>üè¶ SecureBank</h1>
          <span class="tagline">Your Trust, Our Priority</span>
        </div>
        <div class="user-info">
          <span class="welcome">Welcome, John Doe</span>
          <button class="logout-btn" aria-label="Logout Button">Logout</button>
        </div>
      </div>
    </header>

    <!-- Navigation Buttons Row (Above Lab Tabs) -->
    <div class="nav-buttons-row">
      <div class="container">
        <a href="http://localhost:3000" class="nav-button back-button" id="back-button" aria-label="Back Button">‚Üê Back to Labs</a>
        <a href="http://localhost:9004" class="nav-button c2-button" id="view-stolen-button" target="_blank" aria-label="View Stolen Data">üïµÔ∏è View Stolen Data</a>
        <a href="http://localhost:3000/lab-02-writeup" class="nav-button writeup-button" id="writeup-button" target="_blank" aria-label="Lab Writeup">üìñ Writeup</a>
      </div>
    </div>

    <!-- Lab Page Tabs -->
    <nav class="lab-tabs">
      <div class="container">
        <ul>
          <li><a href="#" class="tab-link" data-section="dashboard">Dashboard</a></li>
          <li><a href="#" class="tab-link" data-section="transfer">Transfer</a></li>
          <li><a href="#" class="tab-link" data-section="payments">Bill Pay</a></li>
          <li><a href="#" class="tab-link active" data-section="cards">Cards</a></li>
        </ul>
      </div>
    </nav>

    <main class="main-content">
      <div class="container">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section">
          <h2>Account Dashboard</h2>
          <div class="account-grid">
            <div class="account-card">
              <h3>Checking Account</h3>
              <div class="account-number">****1234</div>
              <div class="account-balance">$12,485.67</div>
            </div>
            <div class="account-card">
              <h3>Savings Account</h3>
              <div class="account-number">****5678</div>
              <div class="account-balance">$45,892.33</div>
            </div>
            <div class="account-card">
              <h3>Credit Card</h3>
              <div class="account-number">****9012</div>
              <div class="account-balance">-$2,156.78</div>
            </div>
          </div>

          <div class="recent-transactions">
            <h3>Recent Transactions</h3>
            <div class="transaction-list">
              <div class="transaction-item">
                <span class="transaction-desc">Amazon Purchase</span>
                <span class="transaction-amount">-$89.99</span>
                <span class="transaction-date">Oct 3, 2024</span>
              </div>
              <div class="transaction-item">
                <span class="transaction-desc">Salary Deposit</span>
                <span class="transaction-amount">+$3,500.00</span>
                <span class="transaction-date">Oct 1, 2024</span>
              </div>
              <div class="transaction-item">
                <span class="transaction-desc">Electric Bill</span>
                <span class="transaction-amount">-$124.50</span>
                <span class="transaction-date">Sep 28, 2024</span>
              </div>
            </div>
          </div>
        </section>

        <!-- Transfer Section -->
        <section id="transfer" class="section">
          <h2>Transfer Money</h2>
          <div class="transfer-form-container">
            <form id="transfer-form" class="banking-form">
              <div class="form-group">
                <label for="from-account">From Account</label>
                <select id="from-account" name="fromAccount" required>
                  <option value="">Select Account</option>
                  <option value="checking">Checking ****1234</option>
                  <option value="savings">Savings ****5678</option>
                </select>
              </div>

              <div class="form-group">
                <label for="to-account">To Account/Routing</label>
                <input
                  type="text"
                  id="to-account"
                  name="toAccount"
                  placeholder="Account or routing number"
                  required
                />
              </div>

              <div class="form-group">
                <label for="transfer-amount">Amount</label>
                <input
                  type="number"
                  id="transfer-amount"
                  name="amount"
                  placeholder="0.00"
                  step="0.01"
                  min="0.01"
                  required
                />
              </div>

              <div class="form-group">
                <label for="transfer-memo">Memo (Optional)</label>
                <input type="text" id="transfer-memo" name="memo" placeholder="What's this for?" />
              </div>

              <button type="submit" class="submit-btn">Transfer Money</button>
            </form>
          </div>
        </section>

        <!-- Bill Pay Section -->
        <section id="payments" class="section">
          <h2>Bill Payment</h2>
          <div class="payment-form-container">
            <form id="payment-form" class="banking-form">
              <div class="form-group">
                <label for="payee">Payee</label>
                <select id="payee" name="payee" required>
                  <option value="">Select Payee</option>
                  <option value="electric">Electric Company</option>
                  <option value="gas">Gas Utility</option>
                  <option value="credit-card">Credit Card Company</option>
                  <option value="mortgage">Mortgage Provider</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div class="form-group">
                <label for="payment-account">Account Number</label>
                <input
                  type="text"
                  id="payment-account"
                  name="accountNumber"
                  placeholder="Payee account number"
                  required
                />
              </div>

              <div class="form-group">
                <label for="payment-amount">Payment Amount</label>
                <input
                  type="number"
                  id="payment-amount"
                  name="amount"
                  placeholder="0.00"
                  step="0.01"
                  min="0.01"
                  required
                />
              </div>

              <div class="form-group">
                <label for="payment-date">Payment Date</label>
                <input type="date" id="payment-date" name="paymentDate" required />
              </div>

              <button type="submit" class="submit-btn">Schedule Payment</button>
            </form>
          </div>
        </section>

        <!-- Credit Cards Section -->
        <section id="cards" class="section active">
          <h2>Credit Card Management</h2>

          <div class="warning" style="background: #fff3cd; border: 2px solid #ffc107; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
            <strong style="color: #856404;">‚ö†Ô∏è LAB ENVIRONMENT:</strong> This is a vulnerable website for educational purposes.
            The banking forms have been compromised with DOM-based skimming attacks. Use ONLY test data (never
            real payment information).
          </div>

          <div class="attack-method" style="background: #ffe8e8; border: 2px solid #e74c3c; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
            <strong style="color: #c0392b;">üî¥ ATTACK METHOD: DOM-Based Skimming</strong><br />
            This page uses DOM manipulation attacks that intercept form data:
            <ul style="margin-top: 0.5rem; margin-left: 1.5rem">
              <li>
                <code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">Form Overlay Attack</code> - Invisible overlay captures keystrokes
              </li>
              <li>
                <code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">DOM Monitoring</code> - Watches for form field changes
              </li>
              <li>
                <code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">Shadow DOM Attack</code> - Uses Shadow DOM to hide malicious code
              </li>
            </ul>
            <p style="margin-top: 0.5rem">
              <strong>Real-world scenario:</strong> Attacker injected malicious JavaScript that manipulates the DOM:<br />
              ‚Ä¢ No file modifications needed - runs entirely in browser<br />
              ‚Ä¢ Bypasses Content Security Policy (CSP) in some cases<br />
              ‚Ä¢ Harder to detect than traditional skimmers<br />
              ‚Ä¢ Can persist across page reloads via localStorage
            </p>
          </div>

          <div style="background: #e8f5e8; border: 2px solid #27ae60; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
            <strong>üí≥ VALID TEST CARD NUMBERS:</strong><br />
            <ul style="margin-top: 0.5rem; margin-left: 1.5rem; color: #27ae60">
              <li><code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">4532123456789010</code> - Visa (16 digits)</li>
              <li><code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">4000000000000002</code> - Visa (16 digits)</li>
              <li><code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">5555555555554444</code> - Mastercard (16 digits)</li>
              <li><code style="background: #34495e; color: #ecf0f1; padding: 0.2rem 0.5rem; border-radius: 3px; font-family: 'Courier New', monospace;">378282246310005</code> - American Express (15 digits)</li>
            </ul>
            <p style="margin-top: 0.5rem; font-size: 0.9rem">
              These numbers pass Luhn algorithm validation. Use any future expiry date (MM/YY) and any
              3-4 digit CVV.
            </p>
          </div>

          <!-- Add New Card Form (Default View) -->
          <div id="add-card-form-container" class="card-form-container">
            <h3>Add New Card</h3>
            <form id="add-card-form" class="banking-form">
              <div class="form-group">
                <label for="card-number">Card Number</label>
                <input
                  type="text"
                  id="card-number"
                  name="cardNumber"
                  data-validate="card-number"
                  placeholder="1234 5678 9012 3456"
                  autocomplete="cc-number"
                  maxlength="19"
                  aria-label="Enter Card Number"
                  required
                />
              </div>

              <div class="form-group">
                <label for="card-holder-name">Cardholder Name</label>
                <input
                  type="text"
                  id="card-holder-name"
                  name="cardHolderName"
                  placeholder="JOHN DOE"
                  autocomplete="cc-name"
                  aria-label="Enter Card Holder Name"
                  required
                />
              </div>

              <div class="form-row">
                <div class="form-group">
                  <label for="card-expiry">Expiry Date</label>
                  <input
                    type="text"
                    id="card-expiry"
                    name="cardExpiry"
                    data-validate="card-expiry"
                    placeholder="MM/YY"
                    autocomplete="cc-exp"
                    maxlength="5"
                    aria-label="Enter Card Expiry Date"
                    required
                  />
                </div>

                <div class="form-group">
                  <label for="card-cvv-input">CVV</label>
                  <input
                    type="text"
                    id="card-cvv-input"
                    name="cvv"
                    data-validate="cvv"
                    placeholder="123"
                    autocomplete="cc-csc"
                    maxlength="4"
                    aria-label="Enter Card CVV Code"
                    required
                  />
                </div>
              </div>

              <div class="form-group">
                <label for="card-billing-zip">Billing ZIP Code</label>
                <input
                  type="text"
                  id="card-billing-zip"
                  name="billingZip"
                  placeholder="12345"
                  autocomplete="postal-code"
                  maxlength="10"
                  aria-label="Enter Card Billing Zip Code"
                  required
                />
              </div>

              <button type="submit" class="submit-btn" aria-label="Submit Button">Add Card</button>
            </form>
          </div>

          <!-- Existing Cards View (Hidden by default) -->
          <div id="existing-cards-container" class="cards-container" style="display: none;">
            <div class="card-details">
              <h3>Primary Credit Card</h3>
              <div class="card-visual">
                <div class="card-number">**** **** **** 9012</div>
                <div class="card-holder">JOHN DOE</div>
                <div class="card-expiry">Exp: 12/27</div>
              </div>
            </div>

            <div class="card-actions">
              <h4>Card Services</h4>
              <button class="action-btn" onclick="showAddCardForm()">Add New Card</button>
              <button class="action-btn" onclick="showPasswordPrompt('activate')">
                Activate New Card
              </button>
              <button class="action-btn" onclick="showPasswordPrompt('freeze')" aria-label="Freeze Card">Freeze Card</button>
              <button class="action-btn" onclick="showPasswordPrompt('limit')" aria-label="Change Limit">Change Limit</button>
              <button class="action-btn" onclick="showPasswordPrompt('pin')" aria-label="Change PIN">Change PIN</button>
            </div>
          </div>

          <!-- Hidden CVV prompt for card actions -->
          <div id="password-modal" class="modal" style="display: none">
            <div class="modal-content">
              <h4>Card Verification</h4>
              <form id="card-action-form">
                <div class="form-group">
                  <label for="card-cvv">Card CVV</label>
                  <input
                    type="text"
                    id="card-cvv"
                    name="cvv"
                    maxlength="4"
                    placeholder="CVV"
                    autocomplete="cc-csc"
                    aria-label="Enter Card CVV code"
                    required
                  />
                </div>
                <div class="modal-actions">
                  <button type="submit" class="submit-btn" aria-label="Verify Button">Verify</button>
                  <button type="button" class="cancel-btn" onclick="closePasswordModal()" aria-label="Cancel Button">
                    Cancel
                  </button>
                </div>
              </form>
            </div>
          </div>
        </section>

      </div>
    </main>

    <!-- Success/Error Messages -->
    <div id="success-message" class="message success" style="display: none">
      <span class="message-text">Operation completed successfully!</span>
      <button class="close-message" onclick="closeMessage('success')" aria-label="Close Message">&times;</button>
    </div>

    <div id="error-message" class="message error" style="display: none">
      <span class="message-text">An error occurred. Please try again.</span>
      <button class="close-message" onclick="closeMessage('error')" aria-label="Close Message">&times;</button>
    </div>

    <!-- Development: Clear Cache Button (only shows in localhost) -->
    <script>
      (function() {
        const hostname = window.location.hostname
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1'
        if (isLocal) {
          const clearCacheBtn = document.createElement('button')
          clearCacheBtn.textContent = 'üóëÔ∏è Clear Cache'
          clearCacheBtn.style.cssText = 'position:fixed;bottom:20px;right:20px;z-index:9999;padding:10px 20px;background:#dc2626;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:600;box-shadow:0 4px 6px rgba(0,0,0,0.3);'
          clearCacheBtn.onclick = function() {
            // Clear all caches
            if ('caches' in window) {
              caches.keys().then(names => {
                names.forEach(name => caches.delete(name))
              })
            }
            // Clear localStorage and sessionStorage
            localStorage.clear()
            sessionStorage.clear()
            // Force reload with cache bypass
            window.location.href = window.location.href.split('?')[0] + '?nocache=' + Date.now()
          }
          document.body.appendChild(clearCacheBtn)
        }
      })()
    </script>

    <!-- Scripts -->
    <script>
      // Cache busting for JS - must happen before script loads
      (function() {
        const hostname = window.location.hostname
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1'
        if (isLocal) {
          const timestamp = Date.now()
          const script = document.createElement('script')
          script.src = 'js/banking.js?v=' + timestamp
          script.id = 'main-js'
          document.body.appendChild(script)
        } else {
          const script = document.createElement('script')
          script.src = 'js/banking.js'
          script.id = 'main-js'
          document.body.appendChild(script)
        }
      })()
    </script>
    <script>
      // Environment-aware URL configuration
      ;(function () {
        const hostname = window.location.hostname
        const isLocal = hostname === 'localhost' || hostname === '127.0.0.1'

        let homeUrl, c2Url, writeupUrl

        if (isLocal) {
          homeUrl = 'http://localhost:3000'
          c2Url = 'http://localhost:9004'
          writeupUrl = 'http://localhost:3000/lab-02-writeup'
        } else if (hostname.includes('labs.stg.pcioasis.com')) {
          homeUrl = 'https://labs.stg.pcioasis.com'
          c2Url = 'https://labs.stg.pcioasis.com/02-dom-skimming-c2'
          writeupUrl = 'https://labs.stg.pcioasis.com/lab-02-writeup'
        } else if (hostname.includes('labs.pcioasis.com')) {
          homeUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app'
          c2Url = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app/02-dom-skimming-c2'
          writeupUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app/lab-02-writeup'
        } else if (hostname.includes('lab-02-dom-skimming')) {
          // Production Cloud Run (combined deployment - nginx + C2 in same container)
          homeUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app'
          c2Url = window.location.protocol + '//' + hostname + '/stolen-data'
          writeupUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app/lab-02-writeup'
        } else if (hostname.includes('run.app') && hostname.includes('lab-02')) {
          // Production Cloud Run direct URL
          homeUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app'
          c2Url = window.location.protocol + '//' + hostname + '/stolen-data'
          writeupUrl = 'https://home-index-prd-mmwwcfi5za-uc.a.run.app/lab-02-writeup'
        } else {
          homeUrl = window.location.protocol + '//' + hostname
          c2Url = window.location.protocol + '//' + hostname + '/c2'
          writeupUrl = window.location.protocol + '//' + hostname.replace('lab-02-dom-skimming', 'home-index-prd-mmwwcfi5za-uc.a.run.app') + '/lab-02-writeup'
        }

        // Update navigation buttons
        const backButton = document.getElementById('back-button')
        const viewStolenButton = document.getElementById('view-stolen-button')
        const writeupButton = document.getElementById('writeup-button')

        if (backButton) {
          backButton.href = homeUrl
        }
        if (viewStolenButton) {
          viewStolenButton.href = c2Url
        }
        if (writeupButton) {
          writeupButton.href = writeupUrl
        }
      })()
    </script>
  </body>
</html>
